<!DOCTYPE html>
<html lang="en">
<head>
	<link rel="icon" type="image/png" href="/favicon.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gamified Productivity System</title>
    <style>
        :root {
  here?
  /* Primitive Color Tokens */
  --color-white: rgba(255, 255, 255, 1);
  --color-black: rgba(0, 0, 0, 1);
  --color-cream-50: rgba(252, 252, 249, 1);
  --color-cream-100: rgba(255, 255, 253, 1);
  --color-gray-200: rgba(245, 245, 245, 1);
  --color-gray-300: rgba(167, 169, 169, 1);
  --color-gray-400: rgba(119, 124, 124, 1);
  --color-slate-500: rgba(98, 108, 113, 1);
  --color-brown-600: rgba(94, 82, 64, 1);
  --color-charcoal-700: rgba(31, 33, 33, 1);
  --color-charcoal-800: rgba(38, 40, 40, 1);
  --color-slate-900: rgba(19, 52, 59, 1);
  --color-teal-300: rgba(50, 184, 198, 1);
  --color-teal-400: rgba(45, 166, 178, 1);
  --color-teal-500: rgba(33, 128, 141, 1);
  --color-teal-600: rgba(29, 116, 128, 1);
  --color-teal-700: rgba(26, 104, 115, 1);
  --color-teal-800: rgba(41, 150, 161, 1);
  --color-red-400: rgba(255, 84, 89, 1);
  --color-red-500: rgba(192, 21, 47, 1);
  --color-orange-400: rgba(230, 129, 97, 1);
  --color-orange-500: rgba(168, 75, 47, 1);

  /* RGB versions for opacity control */
  --color-brown-600-rgb: 94, 82, 64;
  --color-teal-500-rgb: 33, 128, 141;
  --color-slate-900-rgb: 19, 52, 59;
  --color-slate-500-rgb: 98, 108, 113;
  --color-red-500-rgb: 192, 21, 47;
  --color-red-400-rgb: 255, 84, 89;
  --color-orange-500-rgb: 168, 75, 47;
  --color-orange-400-rgb: 230, 129, 97;

  --color-bg-1: rgba(59, 130, 246, 0.08);
  --color-bg-2: rgba(245, 158, 11, 0.08);
  --color-bg-3: rgba(34, 197, 94, 0.08);
  --color-bg-4: rgba(239, 68, 68, 0.08);
  --color-bg-5: rgba(147, 51, 234, 0.08);
  --color-bg-6: rgba(249, 115, 22, 0.08);
  --color-bg-7: rgba(236, 72, 153, 0.08);
  --color-bg-8: rgba(6, 182, 212, 0.08);

  --color-background: var(--color-cream-50);
  --color-surface: var(--color-cream-100);
  --color-text: var(--color-slate-900);
  --color-text-secondary: var(--color-slate-500);
  --color-primary: var(--color-teal-500);
  --color-primary-hover: var(--color-teal-600);
  --color-primary-active: var(--color-teal-700);
  --color-secondary: rgba(var(--color-brown-600-rgb), 0.12);
  --color-secondary-hover: rgba(var(--color-brown-600-rgb), 0.2);
  --color-secondary-active: rgba(var(--color-brown-600-rgb), 0.25);
  --color-border: rgba(var(--color-brown-600-rgb), 0.2);
  --color-btn-primary-text: var(--color-cream-50);
  --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);
  --color-card-border-inner: rgba(var(--color-brown-600-rgb), 0.12);

  --font-family-base: "FKGroteskNeue", "Geist", "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  --font-size-xs: 11px;
  --font-size-sm: 12px;
  --font-size-base: 14px;
  --font-size-md: 14px;
  --font-size-lg: 16px;
  --font-size-xl: 18px;
  --font-size-2xl: 20px;
  --font-size-3xl: 24px;
  --font-size-4xl: 30px;
  --font-weight-normal: 400;
  --font-weight-medium: 500;
  --font-weight-semibold: 550;
  --font-weight-bold: 600;
  --line-height-tight: 1.2;
  --line-height-normal: 1.5;

  --space-4: 4px;
  --space-8: 8px;
  --space-12: 12px;
  --space-16: 16px;
  --space-20: 20px;
  --space-24: 24px;
  --space-32: 32px;

  --radius-sm: 6px;
  --radius-base: 8px;
  --radius-md: 10px;
  --radius-lg: 12px;
  --radius-xl: 16px;
  --radius-2xl: 24px;

  --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02);
  --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
  --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.04), 0 4px 6px -2px rgba(0, 0, 0, 0.02);

  --duration-fast: 150ms;
  --duration-normal: 250ms;
  --ease-standard: cubic-bezier(0.16, 1, 0.3, 1);
}
.gem-btn {
    background: rgba(255, 255, 255, 0.08);
    border: 1px solid rgba(255, 255, 255, 0.12);
    backdrop-filter: blur(6px);
    -webkit-backdrop-filter: blur(6px);

    border-radius: 12px;
    color: #fff;
    font-size: 20px;
    padding: 8px 16px;

    cursor: pointer;
    transition:
        background 0.2s ease,
        transform 0.2s ease,
        box-shadow 0.2s ease;
}
/* === TOP BAR BUTTON LAYOUT === */
.top-controls {
    display: flex;
    justify-content: space-between; /* ü™ú lewo | üíé prawo */
    align-items: center;            /* ta sama linia */
    width: 100%;
    padding: 10px 20px;
}

.gem-btn:hover {
    background: rgba(255, 255, 255, 0.20);
    transform: scale(1.1);
    box-shadow:
        0 8px 24px rgba(255,255,255,0.15),
        0 0 18px rgba(139, 92, 246, 0.35);
}

.gem-btn:active {
    transform: scale(1.04);
}

}
@media (prefers-color-scheme: dark) {
  :root {
    --color-background: #0a0a0f;
    --color-surface: #13131a;
    --color-text: var(--color-gray-200);
    --color-text-secondary: rgba(167, 169, 169, 0.7);
    --color-card-border: rgba(119, 124, 124, 0.2);
    --color-border: rgba(119, 124, 124, 0.3);
  }
}

@font-face {
  font-family: 'FKGroteskNeue';
  src: url('https://r2cdn.perplexity.ai/fonts/FKGroteskNeue.woff2') format('woff2');
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: var(--font-family-base);
    background: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 100%);
    color: var(--color-text);
    overflow-x: hidden;
    min-height: 100vh;
}

.app-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: var(--space-24);
}

/* Hero Section */
.hero-section {
    text-align: center;
    padding: var(--space-32) var(--space-16);
    margin-bottom: var(--space-32);
    position: relative;
    animation: fadeInDown 0.6s var(--ease-standard);
}

@keyframes fadeInDown {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.streak-badge {
    display: inline-flex;
    align-items: center;
    gap: var(--space-12);
    padding: var(--space-16) var(--space-32);
    background: linear-gradient(135deg, rgba(139, 92, 246, 0.2) 0%, rgba(217, 70, 239, 0.2) 100%);
    border: 2px solid rgba(139, 92, 246, 0.4);
    border-radius: var(--radius-2xl);
    font-size: var(--font-size-xl);
    font-weight: var(--font-weight-bold);
    color: #E9D5FF;
    backdrop-filter: blur(10px);
    box-shadow: 0 8px 32px rgba(139, 92, 246, 0.3);
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% {
        box-shadow: 0 8px 32px rgba(139, 92, 246, 0.3);
    }
    50% {
        box-shadow: 0 8px 42px rgba(139, 92, 246, 0.5);
    }
}

.fire-icon {
    font-size: 28px;
    animation: fireFlicker 1.5s infinite;
}

@keyframes fireFlicker {
    0%, 100% { transform: scale(1) rotate(0deg); }
    25% { transform: scale(1.1) rotate(-5deg); }
    75% { transform: scale(1.05) rotate(5deg); }
}

/* XP Bar */
.xp-container {
    margin: var(--space-32) auto;
    max-width: 600px;
    animation: fadeIn 0.8s var(--ease-standard) 0.2s both;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.xp-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-12);
    color: #A78BFA;
    font-weight: var(--font-weight-semibold);
}

.level-badge {
    background: linear-gradient(135deg, #8B5CF6 0%, #D946EF 100%);
    color: white;
    padding: var(--space-8) var(--space-16);
    border-radius: var(--radius-xl);
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-bold);
    box-shadow: 0 4px 16px rgba(139, 92, 246, 0.4);
}

.xp-bar-track {
    height: 24px;
    background: rgba(139, 92, 246, 0.1);
    border-radius: var(--radius-xl);
    border: 2px solid rgba(139, 92, 246, 0.3);
    overflow: hidden;
    position: relative;
}

.xp-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, #8B5CF6 0%, #D946EF 100%);
    border-radius: var(--radius-xl);
    transition: width 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
    position: relative;
    overflow: hidden;
}

.xp-bar-fill::after {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    animation: shimmer 2s infinite;
}

@keyframes shimmer {
    to { left: 200%; }
}

/* Stats Row */
.stats-row {
    display: flex;
    justify-content: center;
    gap: var(--space-24);
    margin: var(--space-32) 0;
    flex-wrap: wrap;
}

.stat-card {
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: var(--radius-lg);
    padding: var(--space-20) var(--space-32);
    text-align: center;
    min-width: 150px;
    animation: fadeInUp 0.6s var(--ease-standard) both;
}

.stat-card:nth-child(1) { animation-delay: 0.1s; }
.stat-card:nth-child(2) { animation-delay: 0.2s; }
.stat-card:nth-child(3) { animation-delay: 0.3s; }

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.stat-value {
    font-size: var(--font-size-3xl);
    font-weight: var(--font-weight-bold);
    color: #22D3EE;
    display: block;
}

.stat-label {
    font-size: var(--font-size-sm);
    color: rgba(255, 255, 255, 0.6);
    margin-top: var(--space-4);
}

/* Category Grid */
.categories-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: var(--space-24);
    margin-top: var(--space-32);
}

.category-card {
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%);
    border: 2px solid rgba(255, 255, 255, 0.1);
    border-radius: var(--radius-xl);
    padding: var(--space-32);
    cursor: pointer;
    position: relative;
    overflow: hidden;
    transition: all 0.3s var(--ease-standard);
    animation: scaleIn 0.5s var(--ease-standard) both;
}

.category-card:nth-child(1) { animation-delay: 0.05s; }
.category-card:nth-child(2) { animation-delay: 0.1s; }
.category-card:nth-child(3) { animation-delay: 0.15s; }
.category-card:nth-child(4) { animation-delay: 0.2s; }
.category-card:nth-child(5) { animation-delay: 0.25s; }
.category-card:nth-child(6) { animation-delay: 0.3s; }
.category-card:nth-child(7) { animation-delay: 0.35s; }
.category-card:nth-child(8) { animation-delay: 0.4s; }

@keyframes scaleIn {
    from {
        opacity: 0;
        transform: scale(0.8);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}

.category-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, var(--card-color) 0%, transparent 100%);
    opacity: 0.1;
    transition: opacity 0.3s var(--ease-standard);
}

.category-card:hover {
    transform: translateY(-8px) scale(1.02);
    border-color: var(--card-color);
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4), 0 0 40px var(--card-color-glow);
}

.category-card:hover::before {
    opacity: 0.2;
}

.category-icon {
    font-size: 48px;
    margin-bottom: var(--space-16);
    display: block;
    filter: drop-shadow(0 0 10px var(--card-color));
    transition: transform 0.3s var(--ease-standard);
}

.category-card:hover .category-icon {
    transform: scale(1.15) rotate(5deg);
}

.category-name {
    font-size: var(--font-size-2xl);
    font-weight: var(--font-weight-bold);
    color: var(--card-color);
    margin-bottom: var(--space-8);
}

.category-tagline {
    font-size: var(--font-size-base);
    color: rgba(255, 255, 255, 0.7);
    margin-bottom: var(--space-16);
}

.category-progress {
    font-size: var(--font-size-sm);
    color: rgba(255, 255, 255, 0.5);
}

/* Mission Detail View */
.mission-view {
    display: none;
    animation: slideInRight 0.4s var(--ease-standard);
}

.mission-view.active {
    display: block;
}

@keyframes slideInRight {
    from {
        opacity: 0;
        transform: translateX(30px);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}

.mission-header {
    display: flex;
    align-items: center;
    gap: var(--space-20);
    margin-bottom: var(--space-32);
    padding: var(--space-24);
    background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%);
    border-radius: var(--radius-xl);
    border: 2px solid var(--category-color);
    justify-content: space-between;
    flex-wrap: wrap;
}

.back-button {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: white;
    padding: var(--space-12) var(--space-20);
    border-radius: var(--radius-base);
    cursor: pointer;
    font-size: var(--font-size-base);
    font-weight: var(--font-weight-medium);
    transition: all 0.2s var(--ease-standard);
    display: flex;
    align-items: center;
    gap: var(--space-8);
}

.back-button:hover {
    background: rgba(255, 255, 255, 0.15);
    transform: translateX(-4px);
}

.mission-header-content {
    flex: 1;
}

.mission-header-icon {
    font-size: 42px;
    filter: drop-shadow(0 0 15px var(--category-color));
}

.mission-header-title {
    font-size: var(--font-size-3xl);
    font-weight: var(--font-weight-bold);
    color: var(--category-color);
    margin-bottom: var(--space-4);
}

.mission-header-tagline {
    font-size: var(--font-size-base);
    color: rgba(255, 255, 255, 0.7);
}


.mission-header-actions {
    display: flex;
    align-items: center;
    gap: 8px;
}

.edit-button {
    background: rgba(255, 255, 255, 0.09);
    border: 1px solid rgba(255, 255, 255, 0.25);
    color: #E9D5FF;
    padding: 8px 14px;
    border-radius: 999px;
    cursor: pointer;
    font-size: 13px;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    transition: all 0.2s var(--ease-standard);
    white-space: nowrap;
}

.edit-button:hover {
    background: rgba(139, 92, 246, 0.2);
    border-color: rgba(139, 92, 246, 0.7);
}

.missions-list {
    display: grid;
    gap: var(--space-20);
}

.mission-card {
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(10px);
    border: 2px solid rgba(255, 255, 255, 0.1);
    border-radius: var(--radius-lg);
    padding: var(--space-24);
    transition: all 0.3s var(--ease-standard);
    position: relative;
    overflow: hidden;
}

.mission-card.completed {
    opacity: 0.6;
    border-color: var(--category-color);
    background: linear-gradient(135deg, rgba(var(--category-color-rgb), 0.1) 0%, rgba(255, 255, 255, 0.02) 100%);
}

.mission-card:hover:not(.completed) {
    border-color: var(--category-color);
    transform: translateX(8px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
}

.mission-top {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: var(--space-16);
    margin-bottom: var(--space-16);
}

.mission-info {
    flex: 1;
}

.mission-title {
    font-size: var(--font-size-xl);
    font-weight: var(--font-weight-semibold);
    color: white;
    margin-bottom: var(--space-8);
}

.mission-description {
    font-size: var(--font-size-base);
    color: rgba(255, 255, 255, 0.7);
    line-height: 1.6;
    margin-bottom: var(--space-12);
}

.mission-meta {
    display: flex;
    gap: var(--space-16);
    font-size: var(--font-size-sm);
}

.mission-duration,
.mission-xp {
    display: flex;
    align-items: center;
    gap: var(--space-4);
    color: rgba(255, 255, 255, 0.6);
}

.mission-xp {
    color: var(--category-color);
    font-weight: var(--font-weight-bold);
}

.mission-checkbox {
    width: 32px;
    height: 32px;
    border: 2px solid var(--category-color);
    border-radius: var(--radius-base);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(255, 255, 255, 0.05);
    transition: all 0.2s var(--ease-standard);
    flex-shrink: 0;
}

.mission-checkbox:hover {
    background: rgba(var(--category-color-rgb), 0.2);
    transform: scale(1.1);
}

.mission-checkbox.checked {
    background: var(--category-color);
}

.mission-checkbox.checked::after {
    content: '‚úì';
    color: white;
    font-size: 20px;
    font-weight: bold;
}

/* Printable View */
.printable-view {
    display: none;
    padding: var(--space-32);
}

.printable-view.active {
    display: block;
}

.print-header {
    text-align: center;
    margin-bottom: var(--space-32);
}

.print-header h1 {
    font-size: var(--font-size-4xl);
    color: #A78BFA;
    margin-bottom: var(--space-16);
}

.print-button {
    background: linear-gradient(135deg, #8B5CF6 0%, #D946EF 100%);
    color: white;
    border: none;
    padding: var(--space-16) var(--space-32);
    border-radius: var(--radius-lg);
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-bold);
    cursor: pointer;
    box-shadow: 0 8px 24px rgba(139, 92, 246, 0.4);
    transition: all 0.2s var(--ease-standard);
}

.print-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 32px rgba(139, 92, 246, 0.5);
}

.print-cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: var(--space-32);
    margin-top: var(--space-32);
}

.print-card {
    background: white;
    border: 3px solid var(--card-color);
    border-radius: var(--radius-xl);
    padding: var(--space-24);
    color: #1a1a2e;
    page-break-inside: avoid;
}

.print-card-header {
    text-align: center;
    margin-bottom: var(--space-20);
    padding-bottom: var(--space-16);
    border-bottom: 2px solid var(--card-color);
}

.print-card-icon {
    font-size: 48px;
    margin-bottom: var(--space-8);
}

.print-card-name {
    font-size: var(--font-size-2xl);
    font-weight: var(--font-weight-bold);
    color: var(--card-color);
    margin-bottom: var(--space-4);
}

.print-card-tagline {
    font-size: var(--font-size-sm);
    color: #666;
}

.print-missions {
    display: flex;
    flex-direction: column;
    gap: var(--space-12);
}

.print-mission {
    display: flex;
    gap: var(--space-12);
    align-items: flex-start;
}

.print-checkbox {
    width: 20px;
    height: 20px;
    border: 2px solid var(--card-color);
    border-radius: 4px;
    flex-shrink: 0;
    margin-top: 2px;
}

.print-mission-content {
    flex: 1;
}

.print-mission-title {
    font-weight: var(--font-weight-semibold);
    color: #1a1a2e;
    margin-bottom: var(--space-4);
}

.print-mission-meta {
    font-size: var(--font-size-xs);
    color: #666;
    display: flex;
    gap: var(--space-12);
}

.print-xp {
    color: var(--card-color);
    font-weight: var(--font-weight-bold);
}

/* Action Buttons */
.action-buttons {
    display: flex;
    justify-content: center;
    gap: var(--space-16);
    margin-top: var(--space-32);
}

.action-button {
    background: rgba(255, 255, 255, 0.1);
    border: 2px solid rgba(255, 255, 255, 0.2);
    color: white;
    padding: var(--space-12) var(--space-24);
    border-radius: var(--radius-lg);
    font-size: var(--font-size-base);
    font-weight: var(--font-weight-medium);
    cursor: pointer;
    transition: all 0.2s var(--ease-standard);
}

.action-button:hover {
    background: rgba(255, 255, 255, 0.15);
    border-color: rgba(255, 255, 255, 0.3);
    transform: translateY(-2px);
}

/* Floating XP */
.floating-xp {
    position: fixed;
    font-size: var(--font-size-3xl);
    font-weight: var(--font-weight-bold);
    color: var(--xp-color);
    pointer-events: none;
    z-index: 1000;
    text-shadow: 0 0 10px var(--xp-color);
    animation: floatUp 1.5s var(--ease-standard) forwards;
}

@keyframes floatUp {
    0% {
        opacity: 1;
        transform: translateY(0) scale(1);
    }
    100% {
        opacity: 0;
        transform: translateY(-100px) scale(1.5);
    }
}

/* Particle Effects */
.particle {
    position: fixed;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    pointer-events: none;
    z-index: 999;
    animation: explode 1s var(--ease-standard) forwards;
}

@keyframes explode {
    0% {
        opacity: 1;
        transform: translate(0, 0) scale(1);
    }
    100% {
        opacity: 0;
        transform: translate(var(--tx), var(--ty)) scale(0);
    }
}

/* Level Up Modal */
.level-up-modal {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0);
    background: linear-gradient(135deg, rgba(139, 92, 246, 0.95) 0%, rgba(217, 70, 239, 0.95) 100%);
    padding: var(--space-32);
    border-radius: var(--radius-2xl);
    text-align: center;
    z-index: 2000;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    opacity: 0;
    transition: all 0.5s var(--ease-standard);
}

.level-up-modal.show {
    transform: translate(-50%, -50%) scale(1);
    opacity: 1;
}

.level-up-modal h2 {
    font-size: var(--font-size-4xl);
    color: white;
    margin-bottom: var(--space-16);
    text-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
}

.level-up-modal p {
    font-size: var(--font-size-xl);
    color: rgba(255, 255, 255, 0.9);
}


/* Edit Overlay */
.edit-overlay {
    position: fixed;
    inset: 0;
    background: radial-gradient(circle at top, rgba(129, 140, 248, 0.18), transparent 55%),
                radial-gradient(circle at bottom, rgba(236, 72, 153, 0.18), transparent 55%),
                rgba(3, 7, 18, 0.92);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    backdrop-filter: blur(10px);
}

.edit-overlay.active {
    display: flex;
}

.edit-modal {
    width: min(960px, 96vw);
    max-height: 86vh;
    background: radial-gradient(circle at top left, rgba(129, 140, 248, 0.16), transparent 55%),
                radial-gradient(circle at bottom right, rgba(236, 72, 153, 0.16), transparent 55%),
                #020617;
    border-radius: 24px;
    border: 1px solid rgba(148, 163, 184, 0.5);
    box-shadow: 0 32px 80px rgba(15, 23, 42, 0.95);
    padding: 20px 24px 18px;
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.edit-modal-header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 12px;
    padding-bottom: 4px;
    border-bottom: 1px solid rgba(148, 163, 184, 0.4);
}

.edit-title-block {
    display: flex;
    align-items: center;
    gap: 12px;
}

.edit-emoji {
    width: 36px;
    height: 36px;
    border-radius: 999px;
    background: radial-gradient(circle at 30% 30%, #fef3c7, #f97316);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    box-shadow: 0 10px 25px rgba(248, 250, 252, 0.2);
}

.edit-modal-header h2 {
    font-size: 18px;
    margin: 0;
}

.edit-subtitle {
    margin: 2px 0 0;
    font-size: 13px;
    color: rgba(226, 232, 240, 0.85);
}

.edit-close-btn {
    border: none;
    background: rgba(15, 23, 42, 0.7);
    border-radius: 999px;
    width: 30px;
    height: 30px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    color: rgba(148, 163, 184, 0.9);
    cursor: pointer;
    font-size: 16px;
    transition: all 0.18s ease-out;
}

.edit-close-btn:hover {
    background: rgba(30, 64, 175, 0.9);
    color: #e5e7eb;
}

.edit-missions-list {
    flex: 1;
    padding: 6px 2px 6px;
    margin-top: 3px;
    margin-bottom: 4px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.edit-mission-row {
    display: grid;
    grid-template-columns: minmax(0, 2.3fr) minmax(0, 1.2fr);
    gap: 12px;
    padding: 10px 11px;
    background: radial-gradient(circle at top, rgba(129, 140, 248, 0.18), transparent 60%),
                rgba(15, 23, 42, 0.95);
    border-radius: 16px;
    border: 1px solid rgba(129, 140, 248, 0.4);
}

.edit-mission-main {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.edit-mission-meta {
    display: grid;
    grid-template-columns: minmax(0, 1.3fr) minmax(0, 0.8fr) auto;
    gap: 6px;
    align-items: center;
}

.edit-input {
    width: 100%;
    border-radius: 999px;
    border: 1px solid rgba(148, 163, 184, 0.7);
    background: rgba(15, 23, 42, 0.85);
    color: #e5e7eb;
    padding: 7px 12px;
    font-size: 13px;
    outline: none;
    resize: none;
}

.edit-input:focus {
    border-color: rgba(129, 140, 248, 0.95);
    box-shadow: 0 0 0 1px rgba(129, 140, 248, 0.7);
}

.edit-desc-input {
    min-height: 48px;
    border-radius: 12px;
}

.edit-duration-input {
    text-align: left;
}

.edit-xp-input {
    max-width: 100px;
    text-align: center;
}

.edit-delete-btn {
    border-radius: 999px;
    border: 1px solid rgba(248, 113, 113, 0.8);
    background: rgba(127, 29, 29, 0.9);
    color: #fee2e2;
    cursor: pointer;
    padding: 6px 9px;
    font-size: 14px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    transition: all 0.18s ease-out;
}

.edit-delete-btn:hover {
    background: rgba(185, 28, 28, 0.95);
    border-color: rgba(248, 113, 113, 1);
}

.empty-edit-hint {
    font-size: 13px;
    color: rgba(148, 163, 184, 0.9);
    text-align: center;
    padding: 18px 4px;
}

.edit-modal-footer {
    display: flex;
    align-items: center;
    gap: 10px;
    padding-top: 8px;
    border-top: 1px solid rgba(30, 64, 175, 0.7);
    margin-top: 2px;
}

.edit-footer-spacer {
    flex: 1;
}

.edit-primary-btn,
.edit-secondary-btn {
    border-radius: 999px;
    padding: 7px 16px;
    font-size: 13px;
    cursor: pointer;
    border-width: 1px;
    border-style: solid;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    transition: all 0.2s ease-out;
    white-space: nowrap;
}

.edit-primary-btn {
    border-color: rgba(129, 140, 248, 1);
    background: linear-gradient(135deg, #4f46e5, #6366f1);
    color: #f9fafb;
    box-shadow: 0 10px 22px rgba(79, 70, 229, 0.6);
}

.edit-primary-btn:hover {
    background: linear-gradient(135deg, #4338ca, #4f46e5);
    transform: translateY(-1px);
    box-shadow: 0 16px 32px rgba(79, 70, 229, 0.7);
}

.edit-secondary-btn {
    border-color: rgba(148, 163, 184, 0.8);
    background: rgba(15, 23, 42, 0.9);
    color: #e5e7eb;
}

.edit-secondary-btn:hover {
    background: rgba(30, 64, 175, 0.9);
    border-color: rgba(129, 140, 248, 0.9);
}

/* Responsive */
@media (max-width: 768px) {
    .categories-grid {
        grid-template-columns: 1fr;
    }

    .stats-row {
        flex-direction: column;
        align-items: center;
    }

    .print-cards-grid {
        grid-template-columns: 1fr;
    }
}

@media print {
    body {
        background: white;
    }

    .hero-section,
    .action-buttons,
    .back-button,
    .print-button {
        display: none !important;
    }

    .print-cards-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: var(--space-20);
    }
}
    </style>
<style>

/* ===== Auth FAB + Modal ===== */
#authFab{
  position: fixed;
  right: 18px;
  bottom: 18px;
  z-index: 9999;
  display:flex;
  align-items:center;
  gap:10px;
}
#authFab .auth-pill{
  display:flex;
  align-items:center;
  gap:10px;
  padding:10px 14px;
  border-radius:16px;
  background: linear-gradient(135deg, #8B5CF6 0%, #D946EF 100%);
  border: none;
  box-shadow: 0 14px 36px rgba(0,0,0,0.48), 0 10px 26px rgba(139, 92, 246, 0.28);
  backdrop-filter: blur(10px);
  cursor:pointer;
  user-select:none;
  position: relative;
  overflow: hidden;
  transition: transform .18s ease, box-shadow .18s ease, filter .18s ease;
}
#authFab .auth-pill::after{
  content:"";
  position:absolute;
  inset:0;
  background: linear-gradient(120deg,
    rgba(255,255,255,0) 30%,
    rgba(255,255,255,0.18) 45%,
    rgba(255,255,255,0) 60%);
  transform: translateX(-120%);
  transition: transform .45s ease;
  pointer-events:none;
}
#authFab .auth-pill:hover{
  transform: translateY(-2px) scale(1.01);
  box-shadow:
    0 18px 48px rgba(0,0,0,0.52),
    0 12px 28px rgba(217, 70, 239, 0.32);
  filter: brightness(1.08);
}
#authFab .auth-pill:hover::after{
  transform: translateX(120%);
}
#authFab .auth-pill:active{
  transform: translateY(0) scale(0.99);
  filter: brightness(0.98);
}
#authFab .auth-dot{
  width:10px;height:10px;border-radius:99px;
  background: rgba(200,200,200,0.55);
  box-shadow: 0 0 0 3px rgba(200,200,200,0.12);
}
#authFab .auth-dot.on{
  background: rgba(80, 220, 160, 0.95);
  box-shadow: 0 0 0 3px rgba(80,220,160,0.14), 0 0 14px rgba(80,220,160,0.35);
}
#authFab .auth-label{
  font-weight: 700;
  font-size: 12.5px;
  letter-spacing: .2px;
  opacity: .92;
  white-space: nowrap;
  max-width: 180px;
  overflow: hidden;
  text-overflow: ellipsis;
}
#authFab .auth-icon{
  width: 34px; height:34px;
  border-radius: 12px;
  display:grid;
  place-items:center;
  background: rgba(255,255,255,0.16);
  border: 1px solid rgba(255,255,255,0.20);
  box-shadow: inset 0 0 22px rgba(255,255,255,0.10);
  font-size: 16px;
}

/* Modal */
#authModal{
  position: fixed;
  inset: 0;
  z-index: 10000;
  display: none;
}
#authModal.open{ display:block; }
#authModal .auth-backdrop{
  position:absolute; inset:0;
  background: rgba(0,0,0,0.55);
  backdrop-filter: blur(6px);
}
#authModal .auth-panel{
  position:absolute;
  right: 18px;
  bottom: 72px;
  width: min(360px, calc(100vw - 36px));
  border-radius: 18px;
  background: rgba(18,18,26,0.82);
  border: 1px solid rgba(170,120,255,0.35);
  box-shadow: 0 20px 60px rgba(0,0,0,0.60);
  padding: 14px;
}
#authModal .auth-head{
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 10px;
  margin-bottom: 10px;
}
#authModal .auth-title{
  font-weight: 900;
  letter-spacing: .2px;
  font-size: 13px;
  background: linear-gradient(135deg, #8B5CF6 0%, #D946EF 100%);
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
  opacity: 1;
}
#authModal .auth-close{
  width: 34px; height: 34px;
  border-radius: 12px;
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.10);
  color: rgba(255,255,255,0.85);
  cursor:pointer;
}
#authModal .auth-sub{
  font-size: 12px;
  line-height: 1.35;
  margin-bottom: 10px;
  background: linear-gradient(135deg, rgba(139, 92, 246, 0.95) 0%, rgba(217, 70, 239, 0.95) 100%);
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
  opacity: .9;
}
#authModal .auth-field{
  width: 100%;
  padding: 10px 12px;
  border-radius: 14px;
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.10);
  color: rgba(255,255,255,0.92);
  outline: none;
  margin: 6px 0;
}
#authModal .auth-row{
  display:flex;
  gap: 10px;
  margin-top: 10px;
}
#authModal .auth-btn{
  flex:1;
  padding: 10px 12px;
  border-radius: 14px;
  font-weight: 900;
  font-size: 12.5px;
  cursor: pointer;
  border: none;
  background: linear-gradient(135deg, #8B5CF6 0%, #D946EF 100%);
  color: rgba(255,255,255,0.95);
  box-shadow: 0 10px 22px rgba(139, 92, 246, 0.28);
  position: relative;
  overflow: hidden;
  transition: transform .18s ease, box-shadow .18s ease, filter .18s ease;
}
#authModal .auth-btn::after{
  content:"";
  position:absolute;
  inset:0;
  background: linear-gradient(120deg,
    rgba(255,255,255,0) 30%,
    rgba(255,255,255,0.22) 45%,
    rgba(255,255,255,0) 60%);
  transform: translateX(-120%);
  transition: transform .45s ease;
  pointer-events:none;
}
#authModal .auth-btn:hover{
  transform: translateY(-2px) scale(1.01);
  box-shadow: 0 16px 34px rgba(0,0,0,0.42), 0 12px 28px rgba(217, 70, 239, 0.30);
  filter: brightness(1.08);
}
#authModal .auth-btn:hover::after{
  transform: translateX(120%);
}
#authModal .auth-btn:active{
  transform: translateY(0) scale(0.99);
  filter: brightness(0.98);
}
#authModal .auth-btn.secondary{
  border: 1px solid rgba(255,255,255,0.14);
  background: rgba(255,255,255,0.07);
  box-shadow: none;
}
#authModal .auth-btn.secondary:hover{
  background: rgba(255,255,255,0.10);
  transform: translateY(-2px) scale(1.01);
  filter: brightness(1.06);
}
#authModal .auth-btn.danger{
  background: linear-gradient(135deg, rgba(255, 90, 90, 0.22) 0%, rgba(255, 90, 90, 0.12) 100%);
  border: 1px solid rgba(255,90,90,0.35);
  box-shadow: 0 10px 22px rgba(255,90,90,0.10);
}
#authModal .auth-btn.danger:hover{
  transform: translateY(-2px) scale(1.01);
  filter: brightness(1.06);
  box-shadow: 0 16px 34px rgba(0,0,0,0.42), 0 12px 28px rgba(255,90,90,0.18);
}
#authModal .auth-msg{
  margin-top: 10px;
  font-size: 12px;
  opacity: .85;
  min-height: 16px;
}

</style>
</head>
<body>
  <div class="top-controls">
      <button id="ladderButton" class="gem-btn">ü™ú</button>
      <button id="gemButton" class="gem-btn">üíé</button>
  </div>

    <div class="app-container">
        <!-- Hero Section -->
        <div id="heroSection" class="hero-section">
            <div class="streak-badge">
                <span class="fire-icon">üî•</span>
                <span id="streakCount">1</span>
                <span>Day Streak</span>
            </div>

            <div class="xp-container">
                <div class="xp-header">
                    <span class="level-badge">Level <span id="currentLevel">1</span></span>
                    <span id="xpDisplay">0 / 100 XP</span>
                </div>
                <div class="xp-bar-track">
                    <div id="xpBarFill" class="xp-bar-fill" style="width: 0%"></div>
                </div>
            </div>

            <div class="stats-row">
                <div class="stat-card">
                    <span id="totalXP" class="stat-value">0</span>
                    <span class="stat-label">Total XP</span>
                </div>
                <div class="stat-card">
                    <span id="missionsCompleted" class="stat-value">0</span>
                    <span class="stat-label">Missions Done</span>
                </div>
                <div class="stat-card">
                    <span id="categoriesEngaged" class="stat-value">0</span>
                    <span class="stat-label">Categories</span>
                </div>
            </div>

            <div class="action-buttons">
              <button class="action-button" id="resetTodayBtn">üîÑ Reset Day</button>
            </div>
        </div>

        <!-- Categories Grid -->
        <div id="categoriesView" class="categories-grid"></div>

        <!-- Mission Detail View -->
        <div id="missionView" class="mission-view"></div>

        <!-- Printable View -->
        <div id="printableView" class="printable-view">
            <div class="print-header">
                <h1>Gamified Productivity Cards</h1>
                <p style="color: rgba(255, 255, 255, 0.7); margin-bottom: var(--space-24);">Your daily mission system for balanced growth</p>
                <button class="print-button" onclick="window.print()">üñ®Ô∏è Print Cards</button>
                <button class="action-button" onclick="showCategoriesView()" style="margin-left: var(--space-16);">‚Üê Back to App</button>
            </div>
            <div id="printCardsGrid" class="print-cards-grid"></div>
        </div>
    </div>

    <div id="levelUpModal" class="level-up-modal">
        <h2>üéâ LEVEL UP! üéâ</h2>
        <p>You've reached Level <span id="newLevel"></span>!</p>
    </div>


    <div id="editOverlay" class="edit-overlay">
        <div class="edit-modal">
            <div class="edit-modal-header">
                <div class="edit-title-block">
                    <div class="edit-emoji">‚úèÔ∏è</div>
                    <div>
                        <h2 id="editCategoryTitle">Edit Tasks</h2>
                        <p class="edit-subtitle">Add, rename or remove missions for this category. Changes are saved in your browser.</p>
                    </div>
                </div>
                <button class="edit-close-btn" onclick="closeEditModal()">‚úï</button>
            </div>
            <div id="editMissionsList" class="edit-missions-list">
                <!-- dynamically rendered -->
            </div>
            <div class="edit-modal-footer">
                <button class="edit-secondary-btn" onclick="addNewTaskRow()">Ôºã Add task</button>
                <div class="edit-footer-spacer"></div>
                <button class="edit-secondary-btn" onclick="closeEditModal()">Cancel</button>
                <button class="edit-primary-btn" onclick="saveEditedMissions()">Save changes</button>
            </div>
        </div>
    </div>

    <script>
    // 1Ô∏è‚É£ LOAD LADDERS INTO MEMORY (GLOBAL)
(function loadLaddersIntoWindow(){
try{
const raw = localStorage.getItem("nal_ladders_v1");
if (!raw) return;
window.ladders = JSON.parse(raw);
console.log("[NAL] ladders loaded:", Object.keys(window.ladders));
} catch(e){
console.warn("[NAL] failed to load ladders:", e);
}
})();
            // App State (persistent + daily counters)
const state = {
  // persistent (NIE resetujƒÖ siƒô dziennie)
  currentXP: 0,
  currentLevel: 1,
  streakDays: 1,
  lastCompletionDate: null,

  // daily reset (resetujƒÖ siƒô dziennie + na Reset Day)
  missionsCompleted: 0,
  completedMissions: new Set(),
  categoriesEngaged: new Set(),
  dayKey: null,
};

/* ============================
   SERVER STORAGE (multi-user)
   - Uses your Node/Express API:
     POST  /api/auth/register
     POST  /api/auth/login
     GET   /api/state
     PUT   /api/state
   - Stores JWT in localStorage under "auth_token"
   - Falls back to localStorage if API is unreachable
============================ */

const API_BASE = ""; // same domain. If API is on subpath, set like "/api"
const AUTH_TOKEN_KEY = "auth_token";

// Small helper UI (optional): open console and run window.apiLogin(...) / window.apiRegister(...)
function getAuthToken(){
  return localStorage.getItem(AUTH_TOKEN_KEY) || "";
}
function setAuthToken(token){
  if (!token) localStorage.removeItem(AUTH_TOKEN_KEY);
  else localStorage.setItem(AUTH_TOKEN_KEY, token);
}

// Safe JSON fetch wrapper
async function apiFetch(path, opts = {}){
  const token = getAuthToken();
  const headers = Object.assign(
    { "Content-Type": "application/json" },
    opts.headers || {},
    token ? { "Authorization": "Bearer " + token } : {}
  );
  const res = await fetch(API_BASE + path, Object.assign({}, opts, { headers }));
  const text = await res.text();
  let json = null;
  try { json = text ? JSON.parse(text) : null; } catch { /* non-json */ }
  if (!res.ok) {
    const msg = (json && (json.error || json.message)) || text || ("HTTP " + res.status);
    const err = new Error(msg);
    err.status = res.status;
    err.body = json ?? text;
    throw err;
  }
  return json;
}

// Auth helpers (multi-user)
async function apiRegister(email, password){
  const out = await apiFetch("/api/auth/register", { method:"POST", body: JSON.stringify({ email, password }) });
  if (out && out.token) setAuthToken(out.token);
  return out;
}
async function apiLogin(email, password){
  const out = await apiFetch("/api/auth/login", { method:"POST", body: JSON.stringify({ email, password }) });
  if (out && out.token) setAuthToken(out.token);
  return out;
}
function apiLogout(){
  setAuthToken("");
}

// Expose for quick testing in console
window.apiRegister = apiRegister;
window.apiLogin = apiLogin;
window.apiLogout = apiLogout;

const StorageMode = {
  LOCAL: "local",
  SERVER: "server",
};

// If token exists, we prefer server; otherwise local.
let storageMode = getAuthToken() ? StorageMode.SERVER : StorageMode.LOCAL;

// Debounced server save
let _saveTimer = null;
function scheduleServerSave(payloadBuilder){
  if (storageMode !== StorageMode.SERVER) return;
  clearTimeout(_saveTimer);
  _saveTimer = setTimeout(async () => {
    try {
      const payload = payloadBuilder();
      await apiFetch("/api/state", { method:"POST", body: JSON.stringify(payload) });
    } catch (e) {
      console.warn("[API] save failed, falling back to local:", e);
      storageMode = StorageMode.LOCAL;
    }
  }, 350);
}

// Minimal payload to keep DB small
function buildServerStatePayload(){
  return {
    // your API can store this as one JSON blob per user
    progress: {
      currentXP: state.currentXP,
      currentLevel: state.currentLevel,
      streakDays: state.streakDays,
      lastCompletionDate: state.lastCompletionDate, // ISO yyyy-mm-dd
      dayKey: state.dayKey,
      missionsCompleted: state.missionsCompleted,
      categoriesEngaged: Array.from(state.categoriesEngaged),
      completedMissions: Array.from(state.completedMissions),
    },
    customMissions: customMissions
  };
}



            // Custom mission editor state (stored in localStorage)
            var customMissions = window.customMissions || {}; // exposed for AI modal/apply
            let editingCategoryId = null;
            let editMissionsBuffer = [];

            // ---------- PROGRESS PERSISTENCE (XP / LEVEL / STREAK) ----------
            function saveProgress(){
  const data = {
    // persistent
    currentXP: state.currentXP,
    currentLevel: state.currentLevel,
    streakDays: state.streakDays,
    lastCompletionDate: state.lastCompletionDate,

    // daily (keep for same-day refresh only)
    dayKey: state.dayKey ?? todayISO(),
    missionsCompleted: state.missionsCompleted,
    categoriesEngaged: Array.from(state.categoriesEngaged),
    completedMissions: Array.from(state.completedMissions),
  };

  // Always keep a local cache (fast + offline)
  try {
    localStorage.setItem("productivityProgress_v1", JSON.stringify(data));
  } catch (e) {
    console.warn("Failed to save local progress (quota/offline?)", e);
  }

  // If logged in, also persist to server (debounced)
  scheduleServerSave(() => buildServerStatePayload());
}
function loadProgressFromLocal(){
  try {
    const raw = localStorage.getItem("productivityProgress_v1");
    if (!raw) {
      state.dayKey = todayISO();
      return;
    }
    const saved = JSON.parse(raw);

    // persistent
    state.currentXP = saved.currentXP ?? state.currentXP ?? 0;
    state.currentLevel = saved.currentLevel ?? state.currentLevel ?? (Math.floor((state.currentXP || 0) / 100) + 1);
    state.streakDays = saved.streakDays ?? state.streakDays ?? 1;
    state.lastCompletionDate = saved.lastCompletionDate ?? state.lastCompletionDate ?? null;

    // daily
    state.dayKey = saved.dayKey ?? todayISO();
    state.missionsCompleted = saved.missionsCompleted ?? 0;
    state.categoriesEngaged = new Set(saved.categoriesEngaged ?? []);
    state.completedMissions = new Set(saved.completedMissions ?? []);

    // daily rollover (local timezone)
    const today = todayISO();
    if (state.dayKey !== today) resetDailyCountersOnly();
  } catch (e) {
    console.error("Failed to load local progress", e);
    state.dayKey = todayISO();
  }
}

// Backward-compatible alias
function loadProgress(){ return loadProgressFromLocal(); }

// Server bootstrap (if logged in)
async function bootstrapFromServerOrLocal(){
  const today = todayISO();

  // 1) always start from local cache (fast)
  loadCustomMissionsFromLocal();
  loadProgressFromLocal();

  // 2) If not logged in, we're done
  if (storageMode !== StorageMode.SERVER) {
    // ensure dayKey sane
    if (state.dayKey !== today) resetDailyCountersOnly();
    saveProgress();
    return;
  }

  // 3) Try server
  try {
    const server = await apiFetch("/api/state", { method:"GET" });
    const sp = server?.progress || null;
    const scm = server?.customMissions || null;

    // If server has something, prefer it
    if (sp) {
      state.currentXP = sp.currentXP ?? state.currentXP ?? 0;
      state.currentLevel = sp.currentLevel ?? state.currentLevel ?? (Math.floor((state.currentXP || 0) / 100) + 1);
      state.streakDays = sp.streakDays ?? state.streakDays ?? 1;
      state.lastCompletionDate = sp.lastCompletionDate ?? state.lastCompletionDate ?? null;

      state.dayKey = sp.dayKey ?? today;
      state.missionsCompleted = sp.missionsCompleted ?? 0;
      state.categoriesEngaged = new Set(sp.categoriesEngaged ?? []);
      state.completedMissions = new Set(sp.completedMissions ?? []);
    }

    if (scm && typeof scm === "object") {
      customMissions = scm;
      window.customMissions = customMissions;
      // also cache locally
      try { localStorage.setItem("customMissions_v1", JSON.stringify(customMissions)); } catch {}
    }

    // daily rollover (server or local)
    if (state.dayKey !== today) resetDailyCountersOnly();

    // push a normalized snapshot back (keeps server in sync + trims)
    saveProgress();

  } catch (e) {
    console.warn("[API] load failed; staying local", e);
    storageMode = StorageMode.LOCAL;
    if (state.dayKey !== today) resetDailyCountersOnly();
    saveProgress();
  }
}


            // ---------- CATEGORIES DATA ----------
            const categories = [
                {
                    id: 'mind',
                    name: 'Mind',
                    tagline: 'Learning & Programming',
                    icon: 'üß†',
                    color: '#8B5CF6',
                    lightColor: '#A78BFA',
                    colorRgb: '139, 92, 246',
                    missions: [
                        {
                            title: 'Code 25-min Session',
                            description: 'JavaScript or PHP focused learning. Pick one concept, build or understand it.',
                            duration: '25 min',
                            xp: 35
                        },
                        {
                            title: 'Review Trading Pattern',
                            description: 'Study one chart pattern or trading concept. Take 2-3 notes.',
                            duration: '15 min',
                            xp: 25
                        },
                        {
                            title: 'Solve Logic Problem',
                            description: 'One coding challenge or mental math puzzle. Push boundaries slightly.',
                            duration: '20 min',
                            xp: 30
                        }
                    ]
                },
                {
                    id: 'body',
                    name: 'Body',
                    tagline: 'Health & Fitness',
                    icon: 'üí™',
                    color: '#EF4444',
                    lightColor: '#F87171',
                    colorRgb: '239, 68, 68',
                    missions: [
                        {
                            title: 'Wing Chun Training',
                            description: '20-min focused session. Forms, drills, or combinations.',
                            duration: '20 min',
                            xp: 40
                        },
                        {
                            title: 'Nature Walk/Hike',
                            description: '30+ minutes outdoors. Observe, breathe, reset mind.',
                            duration: '30 min',
                            xp: 35
                        },
                        {
                            title: 'Stretch & Breathe',
                            description: 'Mobility work and breathing exercises for clarity.',
                            duration: '15 min',
                            xp: 25
                        }
                    ]
                },
                {
                    id: 'creation',
                    name: 'Creation',
                    tagline: 'Build & Express',
                    icon: 'üé®',
                    color: '#F97316',
                    lightColor: '#FB923C',
                    colorRgb: '249, 115, 22',
                    missions: [
                        {
                            title: 'Build One Feature',
                            description: 'Work on your side project or business. One complete feature or section.',
                            duration: '45 min',
                            xp: 50
                        },
                        {
                            title: 'Update Second Brain',
                            description: 'Add 500+ words to your notes, insights, or learning repository.',
                            duration: '30 min',
                            xp: 40
                        },
                        {
                            title: 'Design UI Element',
                            description: 'Create or improve one visual component. Beauty and function.',
                            duration: '25 min',
                            xp: 35
                        }
                    ]
                },
                {
                    id: 'exploration',
                    name: 'Exploration',
                    tagline: 'Discover & Aware',
                    icon: 'üî≠',
                    color: '#06B6D4',
                    lightColor: '#22D3EE',
                    colorRgb: '6, 182, 212',
                    missions: [
                        {
                            title: 'Research New Topic',
                            description: 'Deep dive into trading, tech, or philosophy. Learn something new.',
                            duration: '30 min',
                            xp: 35
                        },
                        {
                            title: 'Educational Content',
                            description: 'Watch or listen to 20-30 min of high-quality educational material.',
                            duration: '30 min',
                            xp: 30
                        },
                        {
                            title: 'Explore New Tool',
                            description: 'Test one new platform, library, or framework. Document first impressions.',
                            duration: '20 min',
                            xp: 25
                        }
                    ]
                },
                {
                    id: 'networking',
                    name: 'Networking',
                    tagline: 'Connect & Lead',
                    icon: 'üëë',
                    color: '#FBBF24',
                    lightColor: '#FCD34D',
                    colorRgb: '251, 191, 36',
                    missions: [
                        {
                            title: 'Network/Outreach',
                            description: 'One meaningful conversation with peer, client, or mentor.',
                            duration: '20 min',
                            xp: 35
                        },
                        {
                            title: 'Help Someone',
                            description: 'Share expertise or solve someone\'s problem. Add value.',
                            duration: '15 min',
                            xp: 30
                        },
                        {
                            title: 'Share Your Insight',
                            description: 'Document and share one lesson learned or breakthrough today.',
                            duration: '10 min',
                            xp: 20
                        }
                    ]
                },
                {
                    id: 'trading',
                    name: 'Trading',
                    tagline: 'Trade & Journal',
                    icon: 'üìä',
                    color: '#6366F1',
                    lightColor: '#818CF8',
                    colorRgb: '99, 102, 241',
                    missions: [
                        {
                            title: 'Daily Review',
                            description: 'What worked? What didn\'t? 3-5 bullet points. Be honest.',
                            duration: '15 min',
                            xp: 25
                        },
                        {
                            title: 'Plan Tomorrow',
                            description: 'Set 5 priority tasks for tomorrow. Maximum 5. Clear and actionable.',
                            duration: '10 min',
                            xp: 20
                        },
                        {
                            title: 'Organize System',
                            description: 'Clean up notes, code, or workspace. One focused cleanup.',
                            duration: '20 min',
                            xp: 30
                        }
                    ]
                },
                {
                    id: 'spirit',
                    name: 'Spirit',
                    tagline: 'Philosophy & Meaning',
                    icon: '‚ú®',
                    color: '#D946EF',
                    lightColor: '#E879F9',
                    colorRgb: '217, 70, 239',
                    missions: [
                        {
                            title: 'Philosophical Read',
                            description: 'Spend 15 min with philosophical text or deep ideas.',
                            duration: '15 min',
                            xp: 25
                        },
                        {
                            title: 'Journaling',
                            description: 'Write freely about purpose, meaning, or current challenges.',
                            duration: '15 min',
                            xp: 25
                        },
                        {
                            title: 'Contemplation',
                            description: 'Meditation or quiet reflection. 10 minutes minimum.',
                            duration: '10 min',
                            xp: 20
                        }
                    ]
                },
                {
                    id: 'order',
                    name: 'Order',
                    tagline: 'Systems & Structure',
                    icon: '‚öôÔ∏è',
                    color: '#A1A1AA',
                    lightColor: '#D4D4D8',
                    colorRgb: '161, 161, 170',
                    missions: [
                        {
                            title: 'Organize Workspace',
                            description: 'Digital or physical. Make one space cleaner and more functional.',
                            duration: '20 min',
                            xp: 25
                        },
                        {
                            title: 'Update System',
                            description: 'Improve one process, template, or workflow. Document changes.',
                            duration: '25 min',
                            xp: 30
                        },
                        {
                            title: 'Archive & Clean',
                            description: 'Clear completed tasks, old notes, or clutter. One focused area.',
                            duration: '15 min',
                            xp: 20
                        }
                    ]
                }
            ];

            // ----- Custom Missions & Helpers -----
            function loadCustomMissionsFromLocal(){
  try {
    const raw = localStorage.getItem("customMissions_v1");
    if (raw) customMissions = JSON.parse(raw);
  } catch (e) {
    customMissions = {};
  }
  window.customMissions = customMissions;
}
// Backward-compatible alias
function loadCustomMissions(){ return loadCustomMissionsFromLocal(); }


            function saveCustomMissions(){
  try {
    localStorage.setItem("customMissions_v1", JSON.stringify(customMissions));
    window.customMissions = customMissions;
  } catch (e) {
    console.error("Failed to save missions (local)", e);
  }
  // If logged in, persist to server as well
  scheduleServerSave(() => buildServerStatePayload());
}


            function getMissionsForCategory(categoryId) {
                const category = categories.find(c => c.id === categoryId);
                if (!category) return [];
                const custom = customMissions[categoryId];
                if (Array.isArray(custom) && custom.length > 0) {
                    return custom;
                }
                return category.missions;
            }

            function getCompletedCountForCategory(categoryId) {
                return Array.from(state.completedMissions)
                    .filter(id => id.startsWith(categoryId + '-')).length;

            }
            function localDateISO(d = new Date()){
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`; // local timezone (important for streak/day rollover)
}
function todayISO(){
  return localDateISO(new Date());
}
function isoYesterday(iso){
  const [y,m,d] = iso.split("-").map(Number);
  const dt = new Date(y, m-1, d);
  dt.setDate(dt.getDate()-1);
  return localDateISO(dt);
}
function resetDailyCountersOnly(){
  // New day rollover: daily counters should reset, but persistent stats stay.
  state.missionsCompleted = 0;
  state.categoriesEngaged = new Set();
  state.completedMissions = new Set();
  state.dayKey = todayISO();
}
function downloadFile(filename, content, mime){
  const blob = new Blob([content], { type: mime || "text/plain;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function exportDoneTasks(categoryId){
  try {
    const category = categories.find(c => c.id === categoryId);
    const missions = getMissionsForCategory(categoryId);

    const doneIds = [...state.completedMissions]
      .filter(id => id.startsWith(categoryId + "-"));

    const rows = doneIds.map(id => {
      const idx = Number(id.split("-")[1]);
      const m = missions[idx];
      return {
        id,
        categoryId,
        categoryName: category?.name || categoryId,
        title: m?.title || "(missing title)",
        description: m?.description || "",
        duration: m?.duration || "",
        xp: m?.xp ?? "",
        exportedAtISO: new Date().toISOString()
      };
    });

    const payload = {
      exportedAtISO: new Date().toISOString(),
      categoryId,
      categoryName: category?.name || categoryId,
      count: rows.length,
      doneTasks: rows
    };

    const filename = `done-tasks_${categoryId}_${todayISO()}.json`;
    downloadFile(
      filename,
      JSON.stringify(payload, null, 2),
      "application/json;charset=utf-8"
    );

  } catch (e) {
    console.error("Export failed", e);
    alert("Export failed. Check console for details.");
  }
}

            // Initialize App
            async function init(){
  try{ setupAuthFab(); }catch(e){}
  await bootstrapFromServerOrLocal();
  renderCategories();
  renderPrintCards();
  updateUI();
}

            // =====================
            // DASHBOARD STORAGE API
            // =====================

            function commitMissions(catId, titles){
  // titles can be array of mission objects or strings; store as-is
  customMissions = customMissions || {};
  customMissions[catId] = titles;
  window.customMissions = customMissions;
  saveCustomMissions();

  window.loadCustomMissions?.();
  window.renderCategories?.();
  window.showMissions?.(catId);
}
window.commitMissions = commitMissions;

          // =====================
          // DASHBOARD RENDERING
          // =====================

            // Render Category Cards
            function renderCategories() {
                const grid = document.getElementById('categoriesView');
                grid.innerHTML = categories.map(category => {
                    const missions = getMissionsForCategory(category.id);
                    const completed = getCompletedCountForCategory(category.id);
                    return `
                    <div class="category-card"
                         style="--card-color: ${category.color}; --card-color-glow: ${category.color}66;"
                         onclick="showMissions('${category.id}')">
                        <span class="category-icon">${category.icon}</span>
                        <h3 class="category-name">${category.name}</h3>
                        <p class="category-tagline">${category.tagline}</p>
                        <p class="category-progress" id="progress-${category.id}">${completed}/${missions.length} completed</p>
                    </div>
                `;
                }).join('');
            }


            // Show Mission Detail View
            function showMissions(categoryId) {
                const category = categories.find(c => c.id === categoryId);
                const missions = getMissionsForCategory(categoryId);
                const missionView = document.getElementById('missionView');

                missionView.innerHTML = `
                    <div class="mission-header" style="--category-color: ${category.color};">
                        <div style="display:flex; align-items:center; gap:12px; flex-wrap:wrap;">
                            <button class="back-button" onclick="showCategoriesView()">‚Üê Back</button>
                            <span class="mission-header-icon">${category.icon}</span>
                            <div class="mission-header-content">
                                <h2 class="mission-header-title">${category.name}</h2>
                                <p class="mission-header-tagline">${category.tagline}</p>
                            </div>
                        </div>
                        <div class="mission-header-actions">

  <button
    class="nal-ai-btn nal-ai-open"
    type="button"
    data-category-id="${categoryId}"
    title="AI suggestions for this category">
    <span class="nal-ai-spark">‚ú®</span>
    <span class="nal-ai-badge">AI</span>
  </button>
  <button
    class="edit-button"
    onclick="openEditModal('${categoryId}')">
    ‚úèÔ∏è Edit tasks
  </button>


</div>

                    </div>
                    <div class="missions-list" style="--category-color: ${category.color}; --category-color-rgb: ${category.colorRgb};">
                        ${missions.map((mission, index) => {
                            const missionId = `${categoryId}-${index}`;
                            const isCompleted = state.completedMissions.has(missionId);
                            return `
                                <div class="mission-card ${isCompleted ? 'completed' : ''}" id="mission-${missionId}">
                                    <div class="mission-top">
                                        <div class="mission-info">
                                            <h4 class="mission-title">${mission.title}</h4>
                                            <p class="mission-description">${mission.description}</p>
                                            <div class="mission-meta">
                                                <span class="mission-duration">‚è±Ô∏è ${mission.duration}</span>
                                                <span class="mission-xp">‚≠ê +${mission.xp} XP</span>
                                            </div>
                                        </div>
                                        <div class="mission-checkbox ${isCompleted ? 'checked' : ''}"
                                             onclick="completeMission('${categoryId}', ${index}, ${mission.xp}, '${category.color}', event)"></div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;

                document.getElementById('categoriesView').style.display = 'none';
                document.getElementById('heroSection').style.display = 'block';
                missionView.classList.add('active');
            }

            // Show Categories View
            function showCategoriesView() {
                document.getElementById('missionView').classList.remove('active');
                document.getElementById('printableView').classList.remove('active');
                document.getElementById('categoriesView').style.display = 'grid';
                document.getElementById('heroSection').style.display = 'block';
            }

            // Show Print View
            function showPrintView() {
                document.getElementById('categoriesView').style.display = 'none';
                document.getElementById('missionView').classList.remove('active');
                document.getElementById('heroSection').style.display = 'none';
                document.getElementById('printableView').classList.add('active');
            }

            // Complete Mission
            function completeMission(categoryId, missionIndex, xp, color, event) {
                const missionId = `${categoryId}-${missionIndex}`;

                // If day changed while tab was open, rollover safely
                if ((state.dayKey ?? todayISO()) !== todayISO()) {
                    resetDailyCountersOnly();
                }

                if (state.completedMissions.has(missionId)) {
                    return; // Already completed
                }

                
// ----- STREAK LOGIC (local date ISO) -----
const todayStr = todayISO(); // yyyy-mm-dd
if (state.lastCompletionDate) {
  if (state.lastCompletionDate !== todayStr) {
    const yesterdayStr = isoYesterday(todayStr);
    if (state.lastCompletionDate === yesterdayStr) state.streakDays += 1;
    else state.streakDays = 1;
  }
} else {
  state.streakDays = 1;
}
state.lastCompletionDate = todayStr;
// -----------------------------------------

                // Mark as completed
                state.completedMissions.add(missionId);
                state.categoriesEngaged.add(categoryId);
                state.missionsCompleted++;
                state.currentXP += xp;

                // Update UI
                const missionCard = document.getElementById(`mission-${missionId}`);
                missionCard.classList.add('completed');
                event.target.classList.add('checked');

                // Animations
                createParticles(event.clientX, event.clientY, color);
                createFloatingXP(event.clientX, event.clientY, xp, color);

                // Check for level up
                const newLevel = Math.floor(state.currentXP / 100) + 1;
                if (newLevel > state.currentLevel) {
                    state.currentLevel = newLevel;
                    showLevelUp(newLevel);
                }

                // Update all UI elements
                updateUI();
                updateCategoryProgress(categoryId);
                saveProgress(); // persist after each mission
            }

            // Create Particle Effects
            function createParticles(x, y, color) {
                for (let i = 0; i < 12; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'particle';
                    particle.style.left = x + 'px';
                    particle.style.top = y + 'px';
                    particle.style.background = color;

                    const angle = (Math.PI * 2 * i) / 12;
                    const distance = 50 + Math.random() * 50;
                    const tx = Math.cos(angle) * distance;
                    const ty = Math.sin(angle) * distance;

                    particle.style.setProperty('--tx', tx + 'px');
                    particle.style.setProperty('--ty', ty + 'px');

                    document.body.appendChild(particle);

                    setTimeout(() => particle.remove(), 1000);
                }
            }

            // Create Floating XP Text
            function createFloatingXP(x, y, xp, color) {
                const floatingXP = document.createElement('div');
                floatingXP.className = 'floating-xp';
                floatingXP.textContent = `+${xp} XP`;
                floatingXP.style.left = x + 'px';
                floatingXP.style.top = y + 'px';
                floatingXP.style.setProperty('--xp-color', color);

                document.body.appendChild(floatingXP);

                setTimeout(() => floatingXP.remove(), 1500);
            }

            // Show Level Up Modal
            function showLevelUp(level) {
                const modal = document.getElementById('levelUpModal');
                document.getElementById('newLevel').textContent = level;
                modal.classList.add('show');

                // Confetti effect
                for (let i = 0; i < 50; i++) {
                    setTimeout(() => {
                        const x = Math.random() * window.innerWidth;
                        const y = Math.random() * window.innerHeight;
                        const colors = ['#8B5CF6', '#D946EF', '#06B6D4', '#F97316', '#EF4444'];
                        const color = colors[Math.floor(Math.random() * colors.length)];
                        createParticles(x, y, color);
                    }, i * 30);
                }

                setTimeout(() => {
                    modal.classList.remove('show');
                }, 3000);
            }

            // Update UI
            function updateUI() {
                // XP Bar
                const xpForCurrentLevel = state.currentXP % 100;
                const xpBarFill = document.getElementById('xpBarFill');
                xpBarFill.style.width = xpForCurrentLevel + '%';

                // Stats
                document.getElementById('currentLevel').textContent = state.currentLevel;
                document.getElementById('xpDisplay').textContent = `${xpForCurrentLevel} / 100 XP`;
                document.getElementById('totalXP').textContent = state.currentXP;
                document.getElementById('missionsCompleted').textContent = state.missionsCompleted;
                document.getElementById('categoriesEngaged').textContent = state.categoriesEngaged.size;
                document.getElementById('streakCount').textContent = state.streakDays;
            }

            // Update Category Progress
            function updateCategoryProgress(categoryId) {
    const missions = getMissionsForCategory(categoryId);
    const completed = Array.from(state.completedMissions)
        .filter(id => id.startsWith(categoryId + '-')).length;

    const progressEl = document.getElementById(`progress-${categoryId}`);
    if (progressEl) {
        progressEl.textContent = `${completed}/${missions.length} completed`;
    }
}


            // Render Print Cards
            function renderPrintCards() {
                const grid = document.getElementById('printCardsGrid');
                grid.innerHTML = categories.map(category => `
                    <div class="print-card" style="--card-color: ${category.color};">
                        <div class="print-card-header">
                            <div class="print-card-icon">${category.icon}</div>
                            <h3 class="print-card-name">${category.name}</h3>
                            <p class="print-card-tagline">${category.tagline}</p>
                        </div>
                        <div class="print-missions">
                            ${getMissionsForCategory(category.id).map(mission => `
                                <div class="print-mission">
                                    <div class="print-checkbox"></div>
                                    <div class="print-mission-content">
                                        <div class="print-mission-title">${mission.title}</div>
                                        <div class="print-mission-meta">
                                            <span>‚è±Ô∏è ${mission.duration}</span>
                                            <span class="print-xp">+${mission.xp} XP</span>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('');
            }

            // ----- Edit Tasks Modal -----
            function escapeHtml(str) {
                return str
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }

            function openEditModal(categoryId) {
                const category = categories.find(c => c.id === categoryId);
                if (!category) return;

                editingCategoryId = categoryId;
                // Start from current missions (custom if exist, else defaults)
                editMissionsBuffer = getMissionsForCategory(categoryId).map(m => ({ ...m }));

                document.getElementById('editCategoryTitle').textContent = category.name;
                renderEditMissionList();
                document.getElementById('editOverlay').classList.add('active');
            }

            function closeEditModal() {
                editingCategoryId = null;
                editMissionsBuffer = [];
                document.getElementById('editOverlay').classList.remove('active');
            }


            function renderEditMissionList() {
                const list = document.getElementById('editMissionsList');
                if (!list) return;

                if (!editMissionsBuffer || editMissionsBuffer.length === 0) {
                    list.innerHTML = '<p class="empty-edit-hint">No tasks yet. Add your first one below. ‚ú®</p>';
                    return;
                }

                list.innerHTML = editMissionsBuffer.map((mission, index) => `
                    <div class="edit-mission-row">
                        <div class="edit-mission-main">
                            <input
                                type="text"
                                class="edit-input edit-title-input"
                                value="${escapeHtml(mission.title || '')}"
                                placeholder="Task title"
                                oninput="updateEditMission(${index}, 'title', this.value)"
                            />
                            <textarea
                                class="edit-input edit-desc-input"
                                placeholder="Short description (optional)"
                                oninput="updateEditMission(${index}, 'description', this.value)"
                            >${escapeHtml(mission.description || '')}</textarea>
                        </div>
                        <div class="edit-mission-meta">
                            <input
                                type="text"
                                class="edit-input edit-duration-input"
                                value="${escapeHtml(mission.duration || '')}"
                                placeholder="Duration"
                                oninput="updateEditMission(${index}, 'duration', this.value)"
                            />
                            <input
                                type="number"
                                class="edit-input edit-xp-input"
                                value="${mission.xp || 10}"
                                min="1"
                                max="500"
                                oninput="updateEditMission(${index}, 'xp', Number(this.value) || 0)"
                            />
                            <button class="edit-delete-btn" onclick="deleteEditMission(${index})">üóë</button>
                        </div>
                    </div>
                `).join('');
            }

            function updateEditMission(index, field, value) {
                if (!editMissionsBuffer[index]) return;
                editMissionsBuffer[index][field] = value;
            }

            function deleteEditMission(index) {
                editMissionsBuffer.splice(index, 1);
                renderEditMissionList();
            }

            function addNewTaskRow() {
                editMissionsBuffer.push({
                    title: '',
                    description: '',
                    duration: '',
                    xp: 10
                });
                renderEditMissionList();
            }

            function saveEditedMissions() {
                if (!editingCategoryId) {
                    closeEditModal();
                    return;
                }

                // Filter out completely empty rows
                const cleaned = editMissionsBuffer
                    .map(m => ({
                        title: (m.title || '').trim(),
                        description: (m.description || '').trim(),
                        duration: (m.duration || '').trim() || '‚Äî',
                        xp: Number(m.xp) || 10
                    }))
                    .filter(m => m.title.length > 0);

                customMissions[editingCategoryId] = cleaned;
                saveCustomMissions();

                // Re-render affected views
                renderCategories();
                renderPrintCards();
                showMissions(editingCategoryId);

                closeEditModal();
            }
            // Initialize on load (deferred until DOMContentLoaded)
// init().catch(console.error);
// ================ TOP BUTTONS LOGIC ================ //
document.addEventListener("DOMContentLoaded", () => {
    init().catch(console.error);

    const gemBtn = document.getElementById("gemButton");
    const ladderBtn = document.getElementById("ladderButton");

    (function attachResetTodayButton(){
  const btn = document.getElementById("resetTodayBtn");
  if (!btn) return;

  const CORE_CATEGORIES = ["mind", "body", "creation", "exploration"];

  function getAllCategoryIds(){
    try {
      if (Array.isArray(categories)) {
        return categories.map(c => c.id).filter(Boolean);
      }
    } catch {}
    return CORE_CATEGORIES.slice();
  }
  function clearCompletedForCategory(catId){
  state.completedMissions = new Set(
    [...state.completedMissions].filter(id => !id.startsWith(catId + "-"))
  );
}

function clearCategory(catId){
  delete customMissions[catId];

  const obj = JSON.parse(localStorage.getItem("customMissions_v1") || "{}");
  delete obj[catId];
  localStorage.setItem("customMissions_v1", JSON.stringify(obj));

  loadCustomMissions();
}

btn.addEventListener("click", (e) => {
  const clearAll = e.shiftKey;
  const targets = clearAll ? getAllCategoryIds() : CORE_CATEGORIES;

  // 1) usu≈Ñ custom taski
  targets.forEach(clearCategory);

  // 2) usu≈Ñ DONE status dla tych samych kategorii
  targets.forEach(clearCompletedForCategory);

  // 3) reset dziennych licznik√≥w UI
  state.missionsCompleted = 0;
  state.categoriesEngaged = new Set();
  state.dayKey = todayISO(); // je≈õli masz dayKey w state

  // 4) UI + persist
  renderCategories();
  renderPrintCards();
  updateUI();
  saveProgress();

  // 5) wr√≥ƒá do widoku kategorii
  showCategoriesView();
});

  btn.title = "Click: clear core categories ¬∑ Shift+Click: clear all categories";
})();
    // --- GEM (Oracle) ---
    if (gemBtn) {
        // LEFT CLICK ‚Üí Remove 5 XP
        gemBtn.addEventListener("click", () => {
            state.currentXP = Math.max(0, state.currentXP - 5);
            state.currentLevel = Math.floor(state.currentXP / 100) + 1;
            updateUI();
            saveProgress();
        });

        // RIGHT CLICK ‚Üí Open oracle page
        gemBtn.addEventListener("contextmenu", (e) => {
            e.preventDefault();
            window.location.href = "oracledashboard.html";
        });
    }

    // --- LADDER ---
    if (ladderBtn) {
        ladderBtn.addEventListener("click", () => {
            window.location.href = "masteryladder.html"; // zmie≈Ñ je≈õli inna nazwa
        });
    }
});

        </script>
        <!-- ===================== NAL AI MODAL COMPONENT (Drop-in) ===================== -->
<style>
  :root{
    --nalai-text: rgba(255,255,255,0.92);
    --nalai-muted: rgba(255,255,255,0.62);
    --nalai-muted2: rgba(255,255,255,0.42);
    --nalai-border: rgba(255,255,255,0.12);
    --nalai-border2: rgba(255,255,255,0.18);
    --nalai-surface: rgba(255,255,255,0.05);
    --nalai-surface2: rgba(255,255,255,0.07);
    --nalai-accent: rgba(168, 85, 247, 0.95);
    --nalai-accent2: rgba(45, 212, 191, 0.9);
    --nalai-good: rgba(34,197,94,0.95);
    --nalai-shadow: 0 24px 90px rgba(0,0,0,0.55);
    --nalai-shadow2: 0 12px 44px rgba(0,0,0,0.45);
    --nalai-ease: cubic-bezier(.16,1,.3,1);
  }

  /* Button (AI icon with corner badge) */
.nal-ai-btn{
  position: relative;
  border: 1px solid rgba(168,85,247,0.30);
  background: rgba(168,85,247,0.10);
  color: var(--nalai-text);

  padding: 10px 14px;
  min-width: 44px;
  height: 38px;

  border-radius: 12px;
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);

  cursor: pointer;
  display:inline-flex;
  align-items:center;
  justify-content:center;

  transition:
    transform .16s var(--nalai-ease),
    background .16s var(--nalai-ease),
    border-color .16s var(--nalai-ease);

  box-shadow: 0 10px 26px rgba(0,0,0,0.22);
  user-select:none;
}

.nal-ai-btn:hover{
  transform: translateY(-1px);
  background: rgba(168,85,247,0.16);
  border-color: rgba(168,85,247,0.45);
}

.nal-ai-btn:active{
  transform: translateY(0) scale(0.99);
}

/* Main icon */
.nal-ai-icon{
  font-size: 18px;
  line-height: 1;
  filter: drop-shadow(0 0 12px rgba(168,85,247,0.55));
}

/* Small "AI" badge in corner */
.nal-ai-badge{
  position: absolute;
  top: -6px;
  right: -6px;

  font-size: 9px;
  font-weight: 800;
  letter-spacing: 0.05em;

  padding: 2px 6px;
  border-radius: 999px;

  background: rgba(255,255,255,0.16);
  border: 1px solid rgba(255,255,255,0.25);
  color: rgba(255,255,255,0.92);

  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);

  pointer-events: none;
}

/* Optional subtle glow on hover */
.nal-ai-btn:hover .nal-ai-badge{
  box-shadow: 0 0 0 4px rgba(168,85,247,0.18);
}


  /* Overlay */
  .nal-ai-overlay{
    position: fixed;
    inset: 0;
    display:none;
    align-items:center;
    justify-content:center;
    padding: 18px;
    z-index: 99999;
    background:
      radial-gradient(circle at 20% 30%, rgba(168,85,247,0.22), transparent 55%),
      radial-gradient(circle at 80% 60%, rgba(45,212,191,0.16), transparent 55%),
      linear-gradient(to bottom, rgba(0,0,0,0.66), rgba(0,0,0,0.82));
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    animation: nalAiFadeIn .18s var(--nalai-ease);
  }
  .nal-ai-overlay.nal-ai-open{ display:flex; }
  @keyframes nalAiFadeIn{ from{opacity:0} to{opacity:1} }

  /* Modal */
  .nal-ai-modal{
    width: min(980px, 100%);
    border-radius: 18px;
    border: 1px solid rgba(255,255,255,0.14);
    background: rgba(16,16,24,0.72);
    backdrop-filter: blur(18px);
    -webkit-backdrop-filter: blur(18px);
    box-shadow: var(--nalai-shadow);
    overflow:hidden;
    transform: translateY(8px) scale(0.99);
    animation: nalAiPopIn .22s var(--nalai-ease) forwards;
    color: var(--nalai-text);
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial;
  }
  @keyframes nalAiPopIn{ to{ transform: translateY(0) scale(1); } }

  .nal-ai-top{
    padding: 16px 18px;
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap: 12px;
    border-bottom: 1px solid rgba(255,255,255,0.10);
    background:
      linear-gradient(135deg, rgba(168,85,247,0.12), transparent 55%),
      linear-gradient(225deg, rgba(45,212,191,0.08), transparent 55%);
  }

  .nal-ai-title{
    display:flex;
    gap: 12px;
    align-items:flex-start;
    min-width:0;
  }
  .nal-ai-brain{
    width: 40px; height: 40px;
    border-radius: 14px;
    display:flex;
    align-items:center;
    justify-content:center;
    background: rgba(168,85,247,0.14);
    border: 1px solid rgba(168,85,247,0.25);
    box-shadow: var(--nalai-shadow2);
    flex: 0 0 auto;
    font-size: 18px;
    filter: drop-shadow(0 0 14px rgba(168,85,247,0.35));
  }
  .nal-ai-title h2{
    margin:0;
    font-size: 18px;
    letter-spacing: .2px;
    line-height: 1.1;
  }
  .nal-ai-sub{
    margin-top: 4px;
    font-size: 12px;
    color: var(--nalai-muted);
    white-space:nowrap;
    overflow:hidden;
    text-overflow: ellipsis;
  }
  .nal-ai-close{
    width: 42px; height: 38px;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.12);
    background: rgba(255,255,255,0.06);
    color: rgba(255,255,255,0.86);
    cursor:pointer;
    transition: .16s var(--nalai-ease);
  }
  .nal-ai-close:hover{ background: rgba(255,255,255,0.12); transform: translateY(-1px); }

  .nal-ai-body{
    padding: 16px 18px 18px;
    display:grid;
    grid-template-columns: 1.4fr 1fr;
    gap: 14px;
  }
  @media (max-width: 900px){
    .nal-ai-body{ grid-template-columns: 1fr; }
  }

  .nal-ai-panel{
    border-radius: 16px;
    border: 1px solid rgba(255,255,255,0.10);
    background: rgba(255,255,255,0.04);
    overflow:hidden;
  }
  .nal-ai-panelHead{
    padding: 12px;
    border-bottom: 1px solid rgba(255,255,255,0.08);
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap: 10px;
  }
  .nal-ai-label{
    font-weight: 800;
    font-size: 12px;
    letter-spacing: .08em;
    text-transform: uppercase;
    color: rgba(255,255,255,0.82);
  }
  .nal-ai-hint{
    font-size: 12px;
    color: var(--nalai-muted);
    white-space: nowrap;
    overflow:hidden;
    text-overflow: ellipsis;
  }

  .nal-ai-suggestions{
    padding: 10px;
    display:flex;
    flex-direction:column;
    gap: 10px;
    max-height: 420px;
    overflow:auto;
  }
  .nal-ai-suggestions::-webkit-scrollbar{ width: 10px; }
  .nal-ai-suggestions::-webkit-scrollbar-thumb{
    background: rgba(255,255,255,0.10);
    border-radius: 999px;
    border: 3px solid rgba(0,0,0,0);
    background-clip: padding-box;
  }

  .nal-ai-card{
    display:flex;
    gap: 12px;
    padding: 12px;
    border-radius: 14px;
    border: 1px solid rgba(255,255,255,0.10);
    background: rgba(255,255,255,0.035);
    transition: .16s var(--nalai-ease);
  }
  .nal-ai-card:hover{
    border-color: rgba(255,255,255,0.18);
    background: rgba(255,255,255,0.06);
    transform: translateY(-1px);
  }

  .nal-ai-check{
    width: 22px; height: 22px;
    border-radius: 7px;
    border: 2px solid rgba(255,255,255,0.20);
    background: rgba(0,0,0,0.10);
    margin-top: 2px;
    flex: 0 0 auto;
    position: relative;
    cursor:pointer;
  }
  .nal-ai-check input{
    position:absolute; inset:0;
    opacity:0; cursor:pointer;
  }
  .nal-ai-check span{
    position:absolute; inset:0;
    border-radius: 6px;
    display:block;
    transition: .16s var(--nalai-ease);
  }
  .nal-ai-check input:checked + span{
    background: rgba(34,197,94,0.22);
    border: 2px solid rgba(34,197,94,0.45);
    box-shadow: 0 0 0 3px rgba(34,197,94,0.12);
  }
  .nal-ai-check input:checked + span::after{
    content:"‚úì";
    position:absolute;
    left: 6px; top: 0px;
    font-weight: 900;
    font-size: 14px;
    color: rgba(255,255,255,0.92);
  }

  .nal-ai-main{ min-width:0; flex:1; }
  .nal-ai-cardTitle{
    font-weight: 900;
    margin: 0;
    font-size: 14px;
    letter-spacing: .15px;
    line-height: 1.15;
  }
  .nal-ai-meta{
    margin-top: 7px;
    display:flex;
    flex-wrap:wrap;
    gap: 8px;
    align-items:center;
    font-size: 11px;
    color: var(--nalai-muted2);
  }
  .nal-ai-badge{
    padding: 4px 8px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,0.12);
    background: rgba(255,255,255,0.05);
    color: rgba(255,255,255,0.70);
  }
  .nal-ai-badgeHi{
    border-color: rgba(168,85,247,0.30);
    background: rgba(168,85,247,0.10);
  }
  .nal-ai-badgeGood{
    border-color: rgba(34,197,94,0.25);
    background: rgba(34,197,94,0.08);
  }
  .nal-ai-why{
    margin-top: 9px;
    font-size: 12px;
    color: var(--nalai-muted);
    line-height: 1.35;
    padding: 10px;
    border-radius: 12px;
    border: 1px dashed rgba(255,255,255,0.14);
    background: rgba(0,0,0,0.10);
  }

  /* Right controls */
  .nal-ai-right{
    display:flex;
    flex-direction:column;
    gap: 12px;
  }
  .nal-ai-block{
    padding: 12px;
    border-radius: 16px;
    border: 1px solid rgba(255,255,255,0.10);
    background: rgba(255,255,255,0.04);
  }
  .nal-ai-block h3{
    margin: 0 0 8px;
    font-size: 12px;
    letter-spacing: .08em;
    text-transform: uppercase;
    color: rgba(255,255,255,0.82);
  }
  .nal-ai-block p{
    margin: 0 0 10px;
    font-size: 12px;
    color: var(--nalai-muted);
    line-height: 1.35;
  }

  .nal-ai-radioRow{ display:flex; flex-direction:column; gap: 8px; }
  .nal-ai-radio{
    display:flex;
    align-items:flex-start;
    gap: 10px;
    padding: 10px;
    border-radius: 14px;
    border: 1px solid rgba(255,255,255,0.10);
    background: rgba(255,255,255,0.03);
    cursor:pointer;
    transition: .16s var(--nalai-ease);
  }
  .nal-ai-radio:hover{
    border-color: rgba(255,255,255,0.18);
    background: rgba(255,255,255,0.06);
  }
  .nal-ai-radio input{
    margin-top: 2px;
    accent-color: rgba(168,85,247,0.95);
  }
  .nal-ai-radio strong{ display:block; font-size: 13px; margin-bottom: 2px; }
  .nal-ai-radio small{ display:block; color: var(--nalai-muted); font-size: 11px; line-height: 1.35; }

  .nal-ai-seg{ display:flex; gap: 8px; flex-wrap:wrap; margin-top: 6px; }
  .nal-ai-seg button{
    flex: 1 1 auto;
    min-width: 110px;
    border-radius: 14px;
    border: 1px solid rgba(255,255,255,0.12);
    background: rgba(255,255,255,0.04);
    color: rgba(255,255,255,0.82);
    padding: 10px;
    cursor:pointer;
    transition: .16s var(--nalai-ease);
    text-align:left;
  }
  .nal-ai-seg button:hover{
    background: rgba(255,255,255,0.08);
    border-color: rgba(255,255,255,0.18);
    transform: translateY(-1px);
  }
  .nal-ai-seg button.nal-ai-active{
    background: linear-gradient(135deg, rgba(168,85,247,0.18), rgba(45,212,191,0.10));
    border-color: rgba(168,85,247,0.30);
    box-shadow: 0 0 0 3px rgba(168,85,247,0.10);
  }
  .nal-ai-seg .t{ font-weight: 900; font-size: 13px; margin-bottom: 2px; display:block; }
  .nal-ai-seg .d{ color: var(--nalai-muted); font-size: 11px; display:block; line-height: 1.25; }

  .nal-ai-options{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
  }
  .nal-ai-pill{
    font-size: 11px;
    padding: 5px 9px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,0.12);
    background: rgba(255,255,255,0.05);
    color: var(--nalai-muted);
    white-space: nowrap;
    display:inline-flex;
    align-items:center;
    gap: 6px;
  }

  /* Footer */
  .nal-ai-foot{
    padding: 14px 18px 16px;
    border-top: 1px solid rgba(255,255,255,0.10);
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap: 10px;
    background: rgba(255,255,255,0.03);
  }
  .nal-ai-footLeft{
    display:flex;
    align-items:center;
    gap: 10px;
    color: var(--nalai-muted);
    font-size: 12px;
    min-width:0;
  }
  .nal-ai-dot{
    width: 8px; height: 8px;
    border-radius: 50%;
    background: var(--nalai-good);
    box-shadow: 0 0 0 4px rgba(34,197,94,0.12);
    flex: 0 0 auto;
  }
  .nal-ai-footRight{
    display:flex;
    gap: 10px;
    flex-wrap:wrap;
    justify-content:flex-end;
  }

  .nal-ai-btnStd{
    border: 1px solid rgba(255,255,255,0.14);
    background: rgba(255,255,255,0.06);
    color: var(--nalai-text);
    padding: 10px 14px;
    border-radius: 12px;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    cursor:pointer;
    transition: transform .16s var(--nalai-ease), background .16s var(--nalai-ease), border-color .16s var(--nalai-ease);
    user-select:none;
    display:inline-flex;
    align-items:center;
    gap: 9px;
  }
  .nal-ai-btnStd:hover{
    transform: translateY(-1px);
    background: rgba(255,255,255,0.10);
    border-color: rgba(255,255,255,0.22);
  }
  .nal-ai-btnStd:active{ transform: translateY(0px) scale(0.99); }

  .nal-ai-primary{
    background: linear-gradient(135deg, rgba(168,85,247,0.22), rgba(217,70,239,0.16));
    border-color: rgba(168,85,247,0.30);
  }
  .nal-ai-primary:hover{
    background: linear-gradient(135deg, rgba(168,85,247,0.30), rgba(217,70,239,0.22));
    border-color: rgba(168,85,247,0.45);
  }
  .nal-ai-ghost{ background: rgba(255,255,255,0.04); }

  .nal-ai-disabled{
    opacity: 0.45;
    pointer-events:none;
    filter: grayscale(0.1);
  }

  .nal-ai-loading{
    position: relative;
  }
  .nal-ai-loading::after{
    content:"";
    position:absolute;
    inset:-1px;
    border-radius: 12px;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.06), transparent);
    animation: nalAiShimmer 1.1s linear infinite;
    pointer-events:none;
  }
  @keyframes nalAiShimmer{
    from{ transform: translateX(-30%); }
    to{ transform: translateX(30%); }
  }
  /* Footer */
.nal-ai-foot{
  ...
}

/* Fix: keep suggestion badges in-flow (prevents floating to top-right) */
.nal-ai-meta .nal-ai-badge{
  position: static !important;
  top: auto !important;
  right: auto !important;
  left: auto !important;
  bottom: auto !important;
  transform: none !important;
}
/* Hide confidence badge by default */
.nal-ai-meta .nal-ai-badgeGood{
  opacity: 0;
  transform: translateY(-2px);
  pointer-events: none;
  transition: opacity .15s ease, transform .15s ease;
}

/* Show confidence on hover of the whole card */
.nal-ai-card:hover .nal-ai-meta .nal-ai-badgeGood{
  opacity: 1;
  transform: translateY(0);
}

</style>

<div class="nal-ai-overlay" id="nalAiOverlay" role="dialog" aria-modal="true" aria-labelledby="nalAiTitle">
  <div class="nal-ai-modal">
    <div class="nal-ai-top">
      <div class="nal-ai-title">
        <div class="nal-ai-brain">üß†</div>
        <div style="min-width:0">
          <h2 id="nalAiTitle">AI Suggestions ¬∑ <span id="nalAiCategoryLabel">Body</span></h2>
          <div class="nal-ai-sub" id="nalAiSubtitle">Source: Mastery Ladder (Body) ¬∑ Generated for today</div>
        </div>
      </div>
      <button class="nal-ai-close" type="button" id="nalAiCloseBtn" aria-label="Close">‚úï</button>
    </div>

    <div class="nal-ai-body">
      <!-- LEFT -->
      <div class="nal-ai-panel">
        <div class="nal-ai-panelHead">
          <div class="nal-ai-label">Suggestions</div>
          <div class="nal-ai-hint" id="nalAiHint">Select what you want to apply ¬∑ you stay in control</div>
        </div>

        <div class="nal-ai-suggestions" id="nalAiSuggestions">
          <!-- injected by JS -->
        </div>
      </div>

      <!-- RIGHT -->
      <div class="nal-ai-right">
        <div class="nal-ai-block">
          <h3>Apply mode</h3>
          <p>Choose how selected suggestions should affect your <b>Today tasks</b> for this category.</p>

          <div class="nal-ai-radioRow" id="nalAiApplyModes">
            <label class="nal-ai-radio">
              <input type="radio" name="nalAiApplyMode" value="replace" checked>
              <div>
                <strong>Replace current tasks</strong>
                <small>Clean slate for today. Recommended for clarity.</small>
              </div>
            </label>

            <label class="nal-ai-radio">
              <input type="radio" name="nalAiApplyMode" value="add">
              <div>
                <strong>Add as new tasks</strong>
                <small>Keep existing tasks and append selected suggestions.</small>
              </div>
            </label>

            <label class="nal-ai-radio">
              <input type="radio" name="nalAiApplyMode" value="append">
              <div>
                <strong>Append to bottom</strong>
                <small>Preserve order. Suggestions become ‚Äúoptional‚Äù at the end.</small>
              </div>
            </label>
          </div>
        </div>

        <div class="nal-ai-block">
          <h3>AI mode</h3>
          <p>Not ‚Äúmodels‚Äù ‚Äî behavior styles for generation and reasoning tone.</p>

          <div class="nal-ai-seg" id="nalAiMode">
            <button type="button" class="nal-ai-active" data-mode="focused" aria-selected="true">
              <span class="t">Focused</span>
              <span class="d">Concrete, execution-first</span>
            </button>
            <button type="button" data-mode="strategic" aria-selected="false">
              <span class="t">Strategic</span>
              <span class="d">Bottlenecks & unlocks</span>
            </button>
            <button type="button" data-mode="recovery" aria-selected="false">
              <span class="t">Recovery</span>
              <span class="d">Low energy, low friction</span>
            </button>
          </div>
        </div>

        <div class="nal-ai-block">
          <h3>Options</h3>
         <div class="nal-ai-options" id="nalAiOptions">
 		 <button type="button" class="nal-ai-pill nal-ai-pillOn" data-opt="avoidDuplicates">‚úÖ Avoid duplicates</button>
 		 <button type="button" class="nal-ai-pill nal-ai-pillOn" data-opt="useLadderProgress">üìà Use ladder progress</button>
  			<button type="button" class="nal-ai-pill nal-ai-pillOn" data-opt="maxTasks">üß© Max 5 tasks</button>
		</div>

        </div>
      </div>
    </div>

    <div class="nal-ai-foot">
      <div class="nal-ai-footLeft">
        <span class="nal-ai-dot"></span>
        <span id="nalAiFooterLine" style="min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
          Ready ¬∑
        </span>
      </div>

      <div class="nal-ai-footRight">
        <button class="nal-ai-btnStd nal-ai-ghost" type="button" id="nalAiRegenBtn">
          <span>‚ü≥</span><span>Regenerate</span>
        </button>
        <button class="nal-ai-btnStd nal-ai-ghost" type="button" id="nalAiCancelBtn">
          <span>‚úï</span><span>Cancel</span>
        </button>
        <button class="nal-ai-btnStd nal-ai-primary nal-ai-disabled" type="button" id="nalAiApplyBtn" title="Select at least 1 suggestion">
          <span>‚úì</span><span>Apply selected</span>
        </button>
      </div>
    </div>
  </div>
</div>

<script>
/* =========================
   NAL AI ‚Äî SERVER BACKEND VERSION (READY DROP-IN)
   - Uses backend endpoint: /api/ai/suggest
   - Sends JWT from localStorage auth_token
   - Logs ladder slice + counts to console
   - Options pills are clickable (requires #nalAiOptions buttons)
========================= */

(function(){
  if (window.__NAL_AI_INSTALLED__) return;
  window.__NAL_AI_INSTALLED__ = true;

  const NAL_AI = {
    endpoint: "/api/ai/suggest",
    suggestionsCount: 5,
    timeoutMs: 20000,
    maxLevels: 6,
    maxTasksPerLevel: 50,
    maxCurrentMissions: 25,
  };

  const els = {
    overlay: () => document.getElementById("nalAiOverlay"),
    closeBtn: () => document.getElementById("nalAiCloseBtn"),
    cancelBtn: () => document.getElementById("nalAiCancelBtn"),
    regenBtn: () => document.getElementById("nalAiRegenBtn"),
    applyBtn: () => document.getElementById("nalAiApplyBtn"),
    suggestionsWrap: () => document.getElementById("nalAiSuggestions"),
    categoryLabel: () => document.getElementById("nalAiCategoryLabel"),
    subtitle: () => document.getElementById("nalAiSubtitle"),
    hint: () => document.getElementById("nalAiHint"),
    modeSeg: () => document.getElementById("nalAiMode"),
    optionsBox: () => document.getElementById("nalAiOptions"),
  };

  const aiState = {
    categoryId: null,
    aiMode: "focused",
    lastResult: null,
    selectedSuggestionIds: new Set(),
    loading: false,
    options: {
      avoidDuplicates: true,
      useLadderProgress: true,
      maxTasks: 5
    }
  };

  // ---------- helpers ----------
  const escapeHtml = (str) => (str ?? "").toString()
    .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
    .replaceAll('"',"&quot;").replaceAll("'","&#039;");

  const uniqStrings = (arr) => {
    const out = [];
    const seen = new Set();
    for (const v of (arr || [])) {
      const s = (v ?? "").toString().trim();
      if (!s) continue;
      const k = s.toLowerCase();
      if (seen.has(k)) continue;
      seen.add(k);
      out.push(s);
    }
    return out;
  };

  const todayISO = () => new Date().toISOString().slice(0,10);

  function getAuthToken(){
    return localStorage.getItem("auth_token") || "";
  }

  function setHint(msg){
    const h = els.hint();
    if (h) h.textContent = msg || "";
  }

  function setApplyEnabled(enabled){
    const btn = els.applyBtn();
    if (!btn) return;
    if (enabled){
      btn.classList.remove("nal-ai-disabled");
      btn.removeAttribute("title");
    } else {
      btn.classList.add("nal-ai-disabled");
      btn.setAttribute("title","Select at least 1 suggestion");
    }
  }

  function getApplyMode(){
    const r = document.querySelector('input[name="nalAiApplyMode"]:checked');
    return r ? r.value : "replace";
  }

  function getCategoryName(categoryId){
    try{
      const c = (window.categories || []).find(x => x.id === categoryId);
      return c?.name || categoryId;
    } catch { return categoryId; }
  }

  function getCurrentMissionsText(categoryId){
    try{
      const missions = window.getMissionsForCategory ? (window.getMissionsForCategory(categoryId) || []) : [];
      const texts = missions.map(m => typeof m === "string" ? m : (m?.title ?? m?.text ?? ""));
      return uniqStrings(texts).slice(0, NAL_AI.maxCurrentMissions);
    } catch { return []; }
  }

  function getLadderSlice(categoryId){
    const ladders = window.ladders;
    if (!ladders) return null;

    const cat =
      ladders[categoryId] ||
      ladders[categoryId?.toLowerCase?.()] ||
      ladders[categoryId?.toUpperCase?.()];

    if (!cat || !cat.levels) return null;

    const isArray = Array.isArray(cat.levels);

    const levelsOut = [];
    for (let i = 0; i < NAL_AI.maxLevels; i++){
      const bucket = isArray ? cat.levels[i] : cat.levels[String(i)];
      const arr = Array.isArray(bucket) ? bucket : [];

      const tasks = arr
        .slice(0, NAL_AI.maxTasksPerLevel)
        .map(t => ({
          id: t?.id ?? null,
          text: t?.text ?? "",
          completed: !!t?.completed
        }))
        .filter(t => (t.text || "").trim().length > 0);

      levelsOut.push({ levelIndex: i, tasks });
    }

    return { categoryId, levels: levelsOut };
  }

  function getPastCompleted(categoryId){
    try{
      const raw = localStorage.getItem("nal_ai_past_completed_v1");
      if (!raw) return [];
      const obj = JSON.parse(raw);
      const arr = obj?.[categoryId] || obj?.[categoryId?.toLowerCase?.()] || [];
      return uniqStrings(arr).slice(0, 200);
    } catch { return []; }
  }

  function debugLogLadder(categoryId){
    const slice = getLadderSlice(categoryId);
    const hasLadder = !!(slice && slice.levels && slice.levels.some(l => (l.tasks || []).length));
    const incompleteCount = hasLadder
      ? slice.levels.flatMap(l => l.tasks || []).filter(t => !t.completed).length
      : 0;

    console.log("[AI] ladder slice:", slice);
    console.log("[AI] has ladder tasks:", hasLadder, "| incomplete:", incompleteCount);

    return { slice, hasLadder, incompleteCount };
  }

  function confBadgeClass(conf){
    return (conf === "high") ? "nal-ai-badgeGood" : "nal-ai-badgeHi";
  }

  // ---------- modal open/close ----------
  function openOverlay(){
    const overlay = els.overlay();
    if (!overlay) return;
    overlay.classList.add("nal-ai-open");
    document.body.style.overflow = "hidden";
  }

  function closeOverlay(){
    const overlay = els.overlay();
    if (!overlay) return;
    overlay.classList.remove("nal-ai-open");
    document.body.style.overflow = "";
  }

  function setHeader(categoryId){
    const label = els.categoryLabel();
    const sub = els.subtitle();
    const nice = getCategoryName(categoryId);
    if (label) label.textContent = nice;
    if (sub) sub.textContent = `Source: Mastery Ladder (${nice}) ¬∑ ${todayISO()}`;
  }

  // ---------- rendering ----------
  function renderSkeleton(){
    const wrap = els.suggestionsWrap();
    if (!wrap) return;
    wrap.innerHTML = `
      <div class="nal-ai-card"><div class="nal-ai-main">
        <div class="nal-ai-cardTitle">Loading‚Ä¶</div>
        <div class="nal-ai-why">Generating suggestions‚Ä¶</div>
      </div></div>
    `;
    setApplyEnabled(false);
  }

  function renderSuggestions(items){
    const wrap = els.suggestionsWrap();
    if (!wrap) return;

    aiState.selectedSuggestionIds.clear();
    wrap.innerHTML = "";

    items.forEach((s, idx) => {
      const id = s.id || `s_${idx}_${Math.random().toString(16).slice(2)}`;

      const el = document.createElement("div");
      el.className = "nal-ai-card";
      el.innerHTML = `
        <label class="nal-ai-check" title="Select">
          <input type="checkbox" data-sid="${escapeHtml(id)}">
          <span></span>
        </label>
        <div class="nal-ai-main">
          <div class="nal-ai-cardTitle">${escapeHtml(s.title || "Task")}</div>
          <div class="nal-ai-meta">
            <span class="nal-ai-badge nal-ai-badgeHi">${escapeHtml(s.tag || "Suggestion")}</span>
            <span class="nal-ai-badge">‚è± ${escapeHtml(s.time || "")}</span>
            <span class="nal-ai-badge">‚≠ê ${escapeHtml(s.xp || "")}</span>
            <span class="nal-ai-badge ${confBadgeClass(s.conf)}">üü¢ Confidence: ${escapeHtml(s.conf || "medium")}</span>
          </div>
          <div class="nal-ai-why">Why: ${escapeHtml(s.why || "")}</div>
        </div>
      `;
      wrap.appendChild(el);
    });

    setApplyEnabled(false);

    wrap.onchange = () => {
      const checks = [...wrap.querySelectorAll('input[type="checkbox"][data-sid]:checked')];
      aiState.selectedSuggestionIds = new Set(checks.map(c => c.dataset.sid));
      setApplyEnabled(checks.length > 0);
    };
  }

  // ---------- Options (clickable) ----------
  function syncOptionsUI(){
    const box = els.optionsBox();
    if (!box) return;

    const btnDup = box.querySelector('[data-opt="avoidDuplicates"]');
    const btnProg = box.querySelector('[data-opt="useLadderProgress"]');
    const btnMax = box.querySelector('[data-opt="maxTasks"]');

    if (btnDup) btnDup.classList.toggle("nal-ai-pillOn", !!aiState.options.avoidDuplicates);
    if (btnProg) btnProg.classList.toggle("nal-ai-pillOn", !!aiState.options.useLadderProgress);

    if (btnMax) {
      btnMax.classList.add("nal-ai-pillOn");
      btnMax.textContent = `üß© Max ${aiState.options.maxTasks} tasks`;
    }
  }

  els.optionsBox()?.addEventListener("click", (e) => {
    const b = e.target.closest("button[data-opt]");
    if (!b) return;

    const opt = b.dataset.opt;

    if (opt === "avoidDuplicates") aiState.options.avoidDuplicates = !aiState.options.avoidDuplicates;
    if (opt === "useLadderProgress") aiState.options.useLadderProgress = !aiState.options.useLadderProgress;

    if (opt === "maxTasks") {
      const curr = aiState.options.maxTasks || 5;
      aiState.options.maxTasks = (curr === 3) ? 5 : (curr === 5) ? 8 : 3;
      NAL_AI.suggestionsCount = aiState.options.maxTasks;
    }

    syncOptionsUI();
    if (aiState.categoryId && !aiState.loading) loadSuggestions(aiState.categoryId);
  });

  // ---------- API call (BACKEND) ----------
  async function callAi(categoryId){
    const controller = new AbortController();
    const timer = setTimeout(() => controller.abort(), NAL_AI.timeoutMs);

    try{
      const token = getAuthToken();
      if (!token) throw new Error("Not logged in (missing auth_token)");

      const { slice, hasLadder, incompleteCount } = debugLogLadder(categoryId);

      const payload = {
        categoryId,
        categoryName: getCategoryName(categoryId),
        aiMode: aiState.aiMode,
        options: { ...aiState.options },
        today: todayISO(),
        ladder: slice,
        currentDashboardTasks: getCurrentMissionsText(categoryId),
        pastCompletedTasks: getPastCompleted(categoryId),
        debug: { hasLadder, incompleteCount }
      };

      console.log("[AI] calling backend:", NAL_AI.endpoint, payload);

      const res = await fetch(NAL_AI.endpoint, {
        method: "POST",
        headers: {
          "Content-Type":"application/json",
          "Authorization": "Bearer " + token
        },
        body: JSON.stringify(payload),
        signal: controller.signal
      });

      const rawText = await res.text();
      console.log("[AI] backend HTTP status:", res.status);
      console.log("[AI] backend raw (first 500):", rawText.slice(0, 500));

      if (!res.ok){
        throw new Error(`Backend AI HTTP ${res.status}: ${rawText.slice(0, 200)}`);
      }

      const data = JSON.parse(rawText);
      const suggestions = data?.suggestions || data?.result?.suggestions || [];
      return { suggestions };

    } finally {
      clearTimeout(timer);
    }
  }

  // ---------- normalize + fallback ----------
  function normalizeResult(raw){
    const suggestions = Array.isArray(raw?.suggestions) ? raw.suggestions : [];

    // tolerate different schemas from backend
    const cleaned = suggestions.map((s,i) => ({
      id: s.id || `s_${i}`,
      title: (s.title ?? s.task ?? s.name ?? "").toString().trim(),
      why: (s.why ?? s.description ?? "").toString().trim(),
      tag: (s.tag ?? "AI").toString().trim(),
      time: (s.time ?? (s.durationMin ? `${s.durationMin}m` : "") ?? "").toString().trim(),
      xp: (s.xp ?? (s.points ?? "") ?? "").toString().trim(),
      conf: (s.conf ?? "medium").toString().trim(),
    })).filter(x => x.title);

    return { suggestions: cleaned.slice(0, NAL_AI.suggestionsCount) };
  }

  function fallbackFromCurrent(categoryId){
    const current = getCurrentMissionsText(categoryId);
    const pick = current.slice(0, NAL_AI.suggestionsCount).map((t,i)=>({
      id: `fb_${i}`,
      title: t,
      why: "Fallback (no AI).",
      tag: "Fallback",
      time: "",
      xp: "",
      conf: "medium",
    }));
    return { suggestions: pick.length ? pick : [{
      id:"fb_0", title:"Pick the next incomplete ladder task", why:"Fallback.", tag:"Fallback", time:"", xp:"", conf:"medium"
    }]};
  }

  async function loadSuggestions(categoryId){
    aiState.loading = true;
    renderSkeleton();
    setHint("Generating‚Ä¶");

    try{
      const raw = await callAi(categoryId);
      const result = normalizeResult(raw);

      // duplicates vs current missions (optional)
      const currentMissions = (() => {
        try {
          const raw = window.getMissionsForCategory
            ? (window.getMissionsForCategory(categoryId) || [])
            : [];
          return raw
            .map(m => typeof m === "string" ? m : (m?.title ?? m?.text ?? ""))
            .map(t => t.toLowerCase().trim())
            .filter(Boolean);
        } catch {
          return [];
        }
      })();

      const currentSet = new Set(currentMissions);

      if (aiState.options.avoidDuplicates) {
        result.suggestions = result.suggestions.filter(
          s => !currentSet.has((s.title || "").toLowerCase().trim())
        );
      }

      if (!result.suggestions.length) {
        const info = {
          suggestions: [{
            id: "none_0",
            title: "No fresh suggestions (duplicates filtered)",
            why: "AI generated tasks that already exist. Try Regenerate, switch AI mode, or disable duplicate filtering.",
            tag: "Info",
            time: "",
            xp: "",
            conf: "medium",
          }]
        };

        aiState.lastResult = info;
        renderSuggestions(info.suggestions);
        setHint("No new suggestions ¬∑ try Regenerate or switch mode");
        return;
      }

      aiState.lastResult = result;
      renderSuggestions(result.suggestions);
      setHint("Ready ¬∑ Select what you want to apply");

    } catch (err){
      console.error(err);
      const fb = fallbackFromCurrent(categoryId);
      aiState.lastResult = fb;
      renderSuggestions(fb.suggestions);
      setHint("AI error ‚Äî showing fallback.");
    } finally {
      aiState.loading = false;
    }
  }

  // ---------- Apply into dashboard missions ----------
  function applySuggestionsToDashboard(categoryId){
    const result = aiState.lastResult;
    if (!result?.suggestions?.length) return;

    const mode = getApplyMode();
    const catId = categoryId || aiState.categoryId;
    if (!catId) return;

    const selected = result.suggestions.filter(s => aiState.selectedSuggestionIds.has(s.id));
    if (!selected.length) return;

    const selectedObjects = selected.map(s => ({
      title: (s.title ?? "").toString().trim(),
      description: (s.why ?? "").toString().trim(),
      duration: (s.time ?? "").toString().trim(),
      xp: (s.xp ?? "").toString().trim(),
    })).filter(m => m.title);

    let current = [];
    try {
      const raw = window.getMissionsForCategory ? (window.getMissionsForCategory(catId) || []) : [];
      current = raw.map(m => {
        if (typeof m === "string") return { title: m, description:"", duration:"", xp:"" };
        return {
          title: (m.title ?? m.text ?? "").toString().trim(),
          description: (m.description ?? "").toString(),
          duration: (m.duration ?? m.time ?? "").toString(),
          xp: (m.xp ?? "").toString(),
        };
      }).filter(m => m.title);
    } catch {}

    const seen = new Set();
    const dedupe = (arr) => arr.filter(m => {
      const k = m.title.toLowerCase();
      if (seen.has(k)) return false;
      seen.add(k);
      return true;
    });

    let next;
    if (mode === "replace") next = dedupe(selectedObjects);
    else next = dedupe([...current, ...selectedObjects]);

    if (typeof window.customMissions === "object" && typeof window.saveCustomMissions === "function") {
      window.customMissions[catId] = next;
      window.saveCustomMissions();
      window.renderCategories?.();
      window.showMissions?.(catId);
    } else {
      const raw = localStorage.getItem("customMissions_v1") || "{}";
      const obj = JSON.parse(raw);
      obj[catId] = next;
      localStorage.setItem("customMissions_v1", JSON.stringify(obj));
      window.loadCustomMissions?.();
      window.renderCategories?.();
      window.showMissions?.(catId);
    }
  }

  // ---------- PUBLIC OPEN (for console) ----------
  function openNalAi(categoryId){
    if (!categoryId) return;
    aiState.categoryId = categoryId;
    setHeader(categoryId);
    openOverlay();
    syncOptionsUI();
    loadSuggestions(categoryId);
  }
  window.openNalAi = openNalAi;
  window.__getLadderSlice = getLadderSlice;

  // ---------- CLICK HANDLERS ----------
  document.addEventListener("click", (e) => {
    const btn = e.target.closest('button.nal-ai-open[data-category-id]');
    if (!btn) return;
    const categoryId = btn.dataset.categoryId || "body";
    openNalAi(categoryId);
  }, true);

  document.addEventListener("click", (e) => {
    const overlay = els.overlay();
    if (!overlay || !overlay.classList.contains("nal-ai-open")) return;

    if (e.target === overlay) { closeOverlay(); return; }
    if (e.target === els.closeBtn() || e.target === els.cancelBtn()) { closeOverlay(); return; }
  }, true);

  window.addEventListener("keydown", (e) => {
    if (e.key === "Escape") closeOverlay();
  }, true);

  els.regenBtn()?.addEventListener("click", () => {
    if (!aiState.categoryId || aiState.loading) return;
    loadSuggestions(aiState.categoryId);
  });

  els.applyBtn()?.addEventListener("click", () => {
    const btn = els.applyBtn();
    if (!btn || btn.classList.contains("nal-ai-disabled")) return;
    applySuggestionsToDashboard(aiState.categoryId);
    closeOverlay();
  });

  els.modeSeg()?.addEventListener("click", (e) => {
    const b = e.target.closest("button[data-mode]");
    if (!b) return;

    const seg = els.modeSeg();
    seg.querySelectorAll("button[data-mode]").forEach(x => {
      x.classList.toggle("nal-ai-active", x === b);
      x.setAttribute("aria-selected", x === b ? "true" : "false");
    });

    aiState.aiMode = b.dataset.mode || "focused";
    if (aiState.categoryId && !aiState.loading) loadSuggestions(aiState.categoryId);
  });

  // init
  syncOptionsUI();



</script>

  
<!-- ===== Auth FAB (bottom-right) ===== -->
<div id="authFab" title="Account">
  <div class="auth-pill" id="authFabBtn">
    <div class="auth-icon">üë§</div>
    <div class="auth-dot" id="authDot"></div>
    <div class="auth-label" id="authLabel">Login</div>
  </div>
</div>

<!-- ===== Auth Modal ===== -->
<div id="authModal" aria-hidden="true">
  <div class="auth-backdrop" id="authBackdrop"></div>
  <div class="auth-panel" role="dialog" aria-modal="true">
    <div class="auth-head">
      <div class="auth-title" id="authTitle">Account</div>
      <button class="auth-close" id="authCloseBtn" aria-label="Close">‚úï</button>
    </div>
    <div class="auth-sub" id="authSub">Log in to sync your progress across devices and accounts.</div>

    <div id="authLoggedOut">
      <input class="auth-field" id="authEmail" placeholder="Email" autocomplete="email">
      <input class="auth-field" id="authPassword" placeholder="Password" type="password" autocomplete="current-password">
      <div class="auth-row">
        <button class="auth-btn" id="authLoginBtn">Login</button>
        <button class="auth-btn secondary" id="authRegisterBtn">Register</button>
      </div>
      <div class="auth-msg" id="authMsgOut"></div>
    </div>

    <div id="authLoggedIn" style="display:none;">
      <div class="auth-sub" id="authMeLine"></div>
      <div class="auth-row">
        <button class="auth-btn secondary" id="authSwitchBtn">Switch account</button>
        <button class="auth-btn danger" id="authLogoutBtn">Logout</button>
      </div>
      <div class="auth-msg" id="authMsgIn"></div>
    </div>
  </div>
</div>


<script>
(function(){
  function decodeTokenPayload(token){
    try{
      const part = token.split(".")[1];
      return JSON.parse(atob(part.replace(/-/g,'+').replace(/_/g,'/')));
    }catch(e){ return null; }
  }

  function getToken(){ return localStorage.getItem("auth_token"); }
  function setToken(t){ localStorage.setItem("auth_token", t); }
  function clearToken(){ localStorage.removeItem("auth_token"); }

  function show(el){ if(el) el.style.display = ""; }
  function hide(el){ if(el) el.style.display = "none"; }

  function openModal(){
    const modal = document.getElementById("authModal");
    if(!modal) return;
    modal.style.display = "flex";
    modal.setAttribute("aria-hidden","false");
    refreshAuthUI();
  }

  function closeModal(){
    const modal = document.getElementById("authModal");
    if(!modal) return;
    modal.style.display = "none";
    modal.setAttribute("aria-hidden","true");
  }

  async function apiCall(path, body){
    const res = await fetch(path, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(body || {})
    });
    const data = await res.json().catch(()=> ({}));
    if(!res.ok) throw new Error(data.error || ("Request failed: " + res.status));
    return data;
  }

  // fallback implementations if not already present
  window.apiLogin = window.apiLogin || (async (email, password) => {
    const data = await apiCall("/api/auth/login", { email, password });
    setToken(data.token);
    return data.user;
  });

  window.apiRegister = window.apiRegister || (async (email, password) => {
    const data = await apiCall("/api/auth/register", { email, password });
    setToken(data.token);
    return data.user;
  });

  window.apiLogout = window.apiLogout || (() => { clearToken(); });

  function clearLocalProgressCaches(){
    // Clear the big local fallback caches so the UI reflects the server account correctly.
    [
      "productivityProgress_v1",
      "customMissions_v1",
      "nal_state_v1",
      "nal_ui_v1"
    ].forEach(k => localStorage.removeItem(k));
  }

  function refreshAuthUI(){
    const token = getToken();
    const payload = token ? decodeTokenPayload(token) : null;

    const fabLabel = document.getElementById("authFabLabel");
    if(fabLabel){
      fabLabel.textContent = payload?.email || "Login";
    }

    const loggedOut = document.getElementById("authLoggedOut");
    const loggedIn = document.getElementById("authLoggedIn");
    const meLine = document.getElementById("authMeLine");

    if(payload){
      hide(loggedOut); show(loggedIn);
      if(meLine) meLine.textContent = `Logged in as ${payload.email} (uid: ${payload.uid})`;
    }else{
      show(loggedOut); hide(loggedIn);
      if(meLine) meLine.textContent = "";
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    const fab = document.getElementById("authFab");
    const closeBtn = document.getElementById("authCloseBtn");
    const backdrop = document.getElementById("authBackdrop");
    const loginBtn = document.getElementById("authLoginBtn");
    const registerBtn = document.getElementById("authRegisterBtn");
    const logoutBtn = document.getElementById("authLogoutBtn");
    const switchBtn = document.getElementById("authSwitchBtn");

    if(fab){
      fab.addEventListener("click", (e) => { e.preventDefault(); openModal(); });
    }else{
      console.warn("[AUTH] authFab not found");
    }

    if(closeBtn) closeBtn.addEventListener("click", closeModal);
    if(backdrop) backdrop.addEventListener("click", closeModal);

    if(loginBtn){
      loginBtn.addEventListener("click", async () => {
        const msg = document.getElementById("authMsgOut");
        try{
          const email = (document.getElementById("authEmail")?.value || "").trim();
          const password = document.getElementById("authPassword")?.value || "";
          if(!email || !password) throw new Error("Enter email + password");
          await window.apiLogin(email, password);
          clearLocalProgressCaches();
          location.reload();
        }catch(e){
          if(msg) msg.textContent = e.message;
        }
      });
    }

    if(registerBtn){
      registerBtn.addEventListener("click", async () => {
        const msg = document.getElementById("authMsgOut");
        try{
          const email = (document.getElementById("authEmail")?.value || "").trim();
          const password = document.getElementById("authPassword")?.value || "";
          if(!email || !password) throw new Error("Enter email + password");
          await window.apiRegister(email, password);
          clearLocalProgressCaches();
          location.reload();
        }catch(e){
          if(msg) msg.textContent = e.message;
        }
      });
    }

    if(logoutBtn){
      logoutBtn.addEventListener("click", () => {
        window.apiLogout();
        clearLocalProgressCaches();
        location.reload();
      });
    }

    if(switchBtn){
      switchBtn.addEventListener("click", () => {
        window.apiLogout();
        clearLocalProgressCaches();
        refreshAuthUI();
        // keep modal open, show logged-out form
      });
    }

    // initial label state
    refreshAuthUI();
  });
})();
</script>

</body>
  </html>
